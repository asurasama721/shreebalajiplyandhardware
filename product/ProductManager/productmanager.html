<!DOCTYPE html>
<html lang="en">

<head>

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Product Management</title>
        <!-- ADD THIS LINE -->
        <script src="https://unpkg.com/@zxing/library@0.19.1/umd/index.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/pdfmake.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/vfs_fonts.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            }

            :root {
                --primary: #2563eb;
                --primary-dark: #1e40af;
                --primary-light: #dbeafe;
                --secondary: #10b981;
                --secondary-dark: #059669;
                --accent: #f59e0b;
                --accent-dark: #d97706;
                --danger: #ef4444;
                --danger-dark: #dc2626;
                --info: #06b6d4;
                --info-dark: #0891b2;
                --dark: #1f2937;
                --gray: #6b7280;
                --gray-light: #9ca3af;
                --light: #f9fafb;
                --border: #e5e7eb;
                --white: #ffffff;
                --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
                --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
                --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
                --radius: 12px;
                --radius-sm: 8px;
                --radius-lg: 16px;
                --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            body {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                background-attachment: fixed;
                color: var(--dark);
                line-height: 1.6;
                min-height: 100vh;
            }

            /* Header Styles */
            .header {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                padding: 20px;
                box-shadow: var(--shadow-lg);
                position: sticky;
                top: 0;
                z-index: 100;
                border-bottom: 1px solid var(--border);
            }

            .nav-buttons {
                display: flex;
                justify-content: center;
                gap: 12px;
                flex-wrap: wrap;
                max-width: 1400px;
                margin: 0 auto;
            }

            .nav-btn {
                padding: 12px 24px;
                background: var(--white);
                color: var(--dark);
                border: 2px solid var(--border);
                border-radius: var(--radius);
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: var(--transition);
                position: relative;
                overflow: hidden;
            }

            .nav-btn::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
                transition: left 0.5s;
            }

            .nav-btn:hover::before {
                left: 100%;
            }

            .nav-btn:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow);
                border-color: var(--primary);
                color: var(--primary);
            }

            .nav-btn.active {
                background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
                border-color: var(--primary);
                color: var(--white);
                box-shadow: var(--shadow);
            }

            .nav-btn[style*="var(--accent)"] {
                background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
                color: var(--white);
                border-color: var(--accent);
            }

            .nav-btn[style*="var(--info)"] {
                background: linear-gradient(135deg, var(--info) 0%, var(--info-dark) 100%);
                color: var(--white);
                border-color: var(--info);
            }

            .nav-btn[style*="var(--secondary)"] {
                background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
                color: var(--white);
                border-color: var(--secondary);
            }

            /* Main Container */
            .main-container {
                /* max-width: 1400px; */
                margin: 0 auto;
                padding: 30px 20px;
            }

            /* Content Sections */
            .content-section {
                display: none;
                width: 50vw;
                margin: 0 auto;
                animation: fadeIn 0.4s ease-in-out;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .content-section.active {
                display: block;
            }

            /* Form Styles */
            .form-container {
                background: var(--white);
                padding: 40px;
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-xl);
                border: 1px solid var(--border);
            }

            .form-container h2 {
                color: var(--primary);
                margin-bottom: 30px;
                text-align: center;
                font-size: 28px;
                font-weight: 700;
                position: relative;
                padding-bottom: 15px;
            }

            .form-container h2::after {
                content: '';
                position: absolute;
                bottom: 0;
                left: 50%;
                transform: translateX(-50%);
                width: 60px;
                height: 4px;
                background: linear-gradient(90deg, var(--primary), var(--secondary));
                border-radius: 2px;
            }

            .product-form {
                display: flex;
                flex-direction: column;
                gap: 20px;
            }

            .form-group {
                display: flex;
                flex-direction: column;
            }

            .form-group label {
                font-weight: 600;
                margin-bottom: 8px;
                color: var(--dark);
                font-size: 14px;
                display: flex;
                align-items: center;
                gap: 4px;
            }

            .form-group input,
            .form-group textarea,
            .form-group select {
                padding: 12px 16px;
                border: 2px solid var(--border);
                border-radius: var(--radius);
                font-size: 14px;
                transition: var(--transition);
                background: var(--white);
            }

            .form-group input:focus,
            .form-group textarea:focus,
            .form-group select:focus {
                border-color: var(--primary);
                outline: none;
                box-shadow: 0 0 0 4px var(--primary-light);
                transform: translateY(-1px);
            }

            .form-group input:hover,
            .form-group textarea:hover,
            .form-group select:hover {
                border-color: var(--primary);
            }

            .form-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }

            .submit-btn {
                padding: 14px 28px;
                background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
                color: white;
                border: none;
                border-radius: var(--radius);
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: var(--transition);
                margin-top: 10px;
                box-shadow: var(--shadow);
                position: relative;
                overflow: hidden;
            }

            .submit-btn::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.3);
                transform: translate(-50%, -50%);
                transition: width 0.6s, height 0.6s;
            }

            .submit-btn:hover::before {
                width: 300px;
                height: 300px;
            }

            .submit-btn:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }

            .submit-btn:active {
                transform: translateY(0);
            }

            /* Items Grid */
            .items-container {
                background: var(--white);
                padding: 40px;
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-xl);
                border: 1px solid var(--border);
            }

            .items-container h2 {
                color: var(--primary);
                margin-bottom: 30px;
                text-align: center;
                font-size: 28px;
                font-weight: 700;
                position: relative;
                padding-bottom: 15px;
            }

            .items-container h2::after {
                content: '';
                position: absolute;
                bottom: 0;
                left: 50%;
                transform: translateX(-50%);
                width: 60px;
                height: 4px;
                background: linear-gradient(90deg, var(--primary), var(--secondary));
                border-radius: 2px;
            }

            .products-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
                gap: 24px;
            }

            .product-card {
                background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
                border: 2px solid var(--border);
                border-radius: var(--radius-lg);
                padding: 24px;
                transition: var(--transition);
                position: relative;
                overflow: hidden;
            }

            .product-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 4px;
                height: 100%;
                background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
                opacity: 0;
                transition: var(--transition);
            }

            .product-card:hover::before {
                opacity: 1;
            }

            .product-card:hover {
                transform: translateY(-4px);
                box-shadow: var(--shadow-xl);
                border-color: var(--primary);
            }

            .product-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 16px;
                padding-bottom: 16px;
                border-bottom: 2px solid var(--border);
            }

            .product-name {
                font-size: 20px;
                font-weight: 700;
                color: var(--primary);
                margin-bottom: 6px;
                line-height: 1.3;
            }

            .product-code {
                color: var(--gray);
                font-size: 12px;
                font-weight: 600;
                background: var(--light);
                padding: 4px 8px;
                border-radius: 6px;
                display: inline-block;
            }

            .product-price {
                color: var(--secondary);
                font-size: 24px;
                font-weight: 700;
                margin-bottom: 8px;
            }

            .product-details {
                margin-bottom: 16px;
            }

            .product-detail {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 6px;
                font-size: 13px;
                padding: 4px 0;
            }

            .product-detail strong {
                color: var(--dark);
                min-width: 80px;
                font-size: 12px;
                font-weight: 600;
            }

            /* Filter Section */
            .filter-section {
                background: var(--white);
                padding: 24px;
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow);
                margin-bottom: 24px;
                display: flex;
                gap: 16px;
                align-items: center;
                flex-wrap: wrap;
                border: 1px solid var(--border);
            }

            .search-bar-container {
                flex: 1;
                min-width: 300px;
            }

            .search-bar {
                width: 100%;
                padding: 12px 16px;
                border: 2px solid var(--border);
                border-radius: var(--radius);
                font-size: 14px;
                transition: var(--transition);
                background: var(--white);
            }

            .search-bar:focus {
                border-color: var(--primary);
                outline: none;
                box-shadow: 0 0 0 4px var(--primary-light);
            }

            .filter-controls {
                display: flex;
                gap: 12px;
                align-items: center;
                flex-wrap: wrap;
            }

            .category-filter {
                padding: 12px 16px;
                border: 2px solid var(--border);
                border-radius: var(--radius);
                font-size: 14px;
                background: var(--white);
                cursor: pointer;
                min-width: 180px;
                transition: var(--transition);
                font-weight: 500;
            }

            .category-filter:focus {
                border-color: var(--primary);
                outline: none;
                box-shadow: 0 0 0 4px var(--primary-light);
            }

            .clear-filters-btn {
                padding: 12px 20px;
                background: linear-gradient(135deg, var(--gray) 0%, var(--dark) 100%);
                color: white;
                border: none;
                border-radius: var(--radius);
                cursor: pointer;
                font-size: 13px;
                font-weight: 600;
                transition: var(--transition);
                box-shadow: var(--shadow);
            }

            .clear-filters-btn:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }

            /* Form Actions */
            .form-actions {
                display: flex;
                gap: 12px;
                margin-top: 10px;
            }

            .cancel-btn {
                padding: 14px 28px;
                background: linear-gradient(135deg, var(--gray) 0%, var(--dark) 100%);
                color: white;
                border: none;
                border-radius: var(--radius);
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: var(--transition);
                flex: 1;
                box-shadow: var(--shadow);
            }

            .cancel-btn:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }

            /* Product Card Enhancements */
            .product-category {
                display: inline-block;
                background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
                color: white;
                padding: 4px 12px;
                border-radius: 20px;
                font-size: 11px;
                font-weight: 600;
                margin-top: 4px;
                box-shadow: var(--shadow-sm);
            }

            /* Button Styles */
            .qr-btn {
                padding: 8px 16px;
                background: linear-gradient(135deg, var(--info) 0%, var(--info-dark) 100%);
                color: white;
                border: none;
                border-radius: var(--radius-sm);
                cursor: pointer;
                font-size: 12px;
                font-weight: 600;
                transition: var(--transition);
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 4px;
                box-shadow: var(--shadow-sm);
            }

            .qr-btn:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow);
            }

            .edit-btn {
                padding: 8px 16px;
                background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
                color: white;
                border: none;
                border-radius: var(--radius-sm);
                cursor: pointer;
                font-size: 12px;
                font-weight: 600;
                transition: var(--transition);
                flex: 1;
                box-shadow: var(--shadow-sm);
            }

            .edit-btn:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow);
            }

            .remove-btn {
                padding: 8px 16px;
                background: linear-gradient(135deg, var(--danger) 0%, var(--danger-dark) 100%);
                color: white;
                border: none;
                border-radius: var(--radius-sm);
                cursor: pointer;
                font-size: 12px;
                font-weight: 600;
                transition: var(--transition);
                flex: 1;
                box-shadow: var(--shadow-sm);
            }

            .remove-btn:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow);
            }

            .product-actions {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr 1fr;
                gap: 10px;
                margin-top: 16px;
            }

            /* Modal Styles */
            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.75);
                z-index: 2000;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(8px);
                animation: fadeIn 0.3s ease;
            }

            .modal-content {
                background: var(--white);
                border-radius: var(--radius-lg);
                padding: 32px;
                max-width: 95%;
                max-height: 90%;
                overflow-y: auto;
                box-shadow: var(--shadow-xl);
                animation: modalSlideIn 0.3s ease;
                border: 1px solid var(--border);
            }

            @keyframes modalSlideIn {
                from {
                    opacity: 0;
                    transform: translateY(-50px) scale(0.95);
                }

                to {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }

            .modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 24px;
                padding-bottom: 16px;
                border-bottom: 2px solid var(--border);
            }

            .modal-title {
                font-size: 24px;
                font-weight: 700;
                color: var(--primary);
            }

            .close-btn {
                background: var(--light);
                border: none;
                font-size: 28px;
                cursor: pointer;
                color: var(--gray);
                transition: var(--transition);
                padding: 4px 12px;
                border-radius: var(--radius-sm);
                line-height: 1;
            }

            .close-btn:hover {
                color: var(--danger);
                background: #fee2e2;
                transform: scale(1.1);
            }

            /* QR Modal Styles */
            .qr-modal-content {
                max-width: 450px;
                text-align: center;
            }

            .qr-container {
                padding: 20px;
            }

            #qrCodeCanvas {
                display: flex;
                justify-content: center;
                margin: 20px 0;
                background: var(--white);
                padding: 20px;
                border-radius: var(--radius);
                border: 2px solid var(--border);
                box-shadow: var(--shadow);
            }

            .qr-info {
                color: var(--gray);
                margin: 16px 0;
                font-size: 14px;
            }

            .qr-actions {
                margin-top: 20px;
            }

            .download-btn {
                padding: 12px 24px;
                background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
                color: white;
                border: none;
                border-radius: var(--radius);
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: var(--transition);
                display: flex;
                align-items: center;
                gap: 8px;
                margin: 0 auto;
                box-shadow: var(--shadow);
            }

            .download-btn:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }

            /* Batch Add Modal */
            .batch-modal-content {
                max-width: 700px;
            }

            .batch-textarea {
                width: 100%;
                height: 350px;
                padding: 16px;
                border: 2px solid var(--border);
                border-radius: var(--radius);
                font-family: 'Courier New', monospace;
                font-size: 13px;
                resize: vertical;
                margin-bottom: 20px;
                transition: var(--transition);
            }

            .batch-textarea:focus {
                border-color: var(--primary);
                outline: none;
                box-shadow: 0 0 0 4px var(--primary-light);
            }

            .batch-info {
                background: linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%);
                padding: 16px;
                border-radius: var(--radius);
                margin-bottom: 20px;
                font-size: 13px;
                border-left: 4px solid var(--info);
                box-shadow: var(--shadow-sm);
            }

            /* JSON Container */
            .json-container {
                background: var(--white);
                padding: 40px;
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-xl);
                border: 1px solid var(--border);
            }

            .json-container h2 {
                color: var(--primary);
                margin-bottom: 30px;
                text-align: center;
                font-size: 28px;
                font-weight: 700;
                position: relative;
                padding-bottom: 15px;
            }

            .json-container h2::after {
                content: '';
                position: absolute;
                bottom: 0;
                left: 50%;
                transform: translateX(-50%);
                width: 60px;
                height: 4px;
                background: linear-gradient(90deg, var(--primary), var(--secondary));
                border-radius: 2px;
            }

            .json-header {
                display: flex;
                gap: 12px;
                margin-bottom: 20px;
                justify-content: center;
            }

            .copy-btn,
            .refresh-btn {
                padding: 10px 20px;
                background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
                color: white;
                border: none;
                border-radius: var(--radius);
                cursor: pointer;
                font-size: 13px;
                font-weight: 600;
                transition: var(--transition);
                box-shadow: var(--shadow);
            }

            .copy-btn:hover,
            .refresh-btn:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }

            .json-output {
                background: #1e293b;
                color: #e2e8f0;
                padding: 24px;
                border-radius: var(--radius);
                overflow-x: auto;
                font-family: 'Courier New', monospace;
                font-size: 13px;
                line-height: 1.6;
                max-height: 600px;
                overflow-y: auto;
                box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
            }

            /* Notification */
            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
                color: white;
                padding: 16px 24px;
                border-radius: var(--radius);
                box-shadow: var(--shadow-xl);
                z-index: 1000;
                transform: translateX(400px);
                transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .notification.show {
                transform: translateX(0);
            }

            .notification.hidden {
                display: none;
            }

            .notification.error {
                background: linear-gradient(135deg, var(--danger) 0%, var(--danger-dark) 100%);
            }

            .notification.info {
                background: linear-gradient(135deg, var(--info) 0%, var(--info-dark) 100%);
            }

            .notification.warning {
                background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            }

            /* Edit Mode Styles */
            .edit-mode .submit-btn {
                background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            }

            /* Variant Styles */
            .variant-section {
                background: var(--light);
                padding: 20px;
                border-radius: var(--radius);
                margin: 20px 0;
                border: 2px solid var(--border);
            }

            .variant-toggle {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 20px;
                cursor: pointer;
            }

            .variant-toggle input {
                margin: 0;
                width: 20px;
                height: 20px;
                cursor: pointer;
            }

            .variants-container {
                display: none;
            }

            .variants-container.show {
                display: block;
            }

            .variant-item {
                background: var(--white);
                padding: 20px;
                border-radius: var(--radius);
                margin-bottom: 16px;
                border: 2px solid var(--border);
                transition: var(--transition);
            }

            .variant-item:hover {
                border-color: var(--primary);
                box-shadow: var(--shadow);
            }

            .variant-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 16px;
                padding-bottom: 12px;
                border-bottom: 2px solid var(--border);
            }

            .variant-name {
                font-weight: 700;
                color: var(--primary);
                font-size: 16px;
            }

            .remove-variant-btn {
                background: linear-gradient(135deg, var(--danger) 0%, var(--danger-dark) 100%);
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: var(--radius-sm);
                cursor: pointer;
                font-size: 12px;
                font-weight: 600;
                transition: var(--transition);
                box-shadow: var(--shadow-sm);
            }

            .remove-variant-btn:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow);
            }

            .add-variant-btn {
                background: linear-gradient(135deg, var(--info) 0%, var(--info-dark) 100%);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: var(--radius);
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                margin-top: 12px;
                transition: var(--transition);
                box-shadow: var(--shadow);
            }

            .add-variant-btn:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }

            /* Description Editor Styles */
            .description-editor {
                border: 2px solid var(--border);
                border-radius: var(--radius);
                padding: 20px;
                background: var(--light);
            }

            .editor-toolbar {
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }

            .editor-btn {
                padding: 10px 16px;
                background: linear-gradient(135deg, var(--info) 0%, var(--info-dark) 100%);
                color: white;
                border: none;
                border-radius: var(--radius-sm);
                cursor: pointer;
                font-size: 12px;
                font-weight: 600;
                transition: var(--transition);
                box-shadow: var(--shadow-sm);
            }

            .editor-btn:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow);
            }

            .config-panel {
                background: var(--white);
                border: 2px solid var(--border);
                border-radius: var(--radius);
                padding: 20px;
                margin-bottom: 20px;
            }

            .config-panel h4 {
                margin-bottom: 16px;
                color: var(--primary);
                font-weight: 700;
            }

            .editor-input-group {
                display: flex;
                flex-direction: column;
                gap: 8px;
                margin-bottom: 12px;
            }

            .editor-input-group label {
                font-weight: 600;
                font-size: 13px;
            }

            .editor-input {
                padding: 10px;
                border: 2px solid var(--border);
                border-radius: var(--radius-sm);
                font-size: 13px;
                transition: var(--transition);
            }

            .editor-input:focus {
                border-color: var(--primary);
                outline: none;
                box-shadow: 0 0 0 4px var(--primary-light);
            }

            .css-panel {
                background: #f8f9fa;
                border: 2px solid var(--border);
                border-radius: var(--radius);
                padding: 20px;
                margin: 12px 0;
            }

            .css-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
                gap: 12px;
            }

            .css-group {
                display: flex;
                flex-direction: column;
                gap: 6px;
            }

            .css-group label {
                font-size: 11px;
                font-weight: 600;
                color: var(--gray);
            }

            .css-group select,
            .css-group input {
                padding: 8px;
                border: 2px solid var(--border);
                border-radius: var(--radius-sm);
                font-size: 11px;
                transition: var(--transition);
            }

            .css-group select:focus,
            .css-group input:focus {
                border-color: var(--primary);
                outline: none;
            }

            .panel-actions {
                display: flex;
                gap: 12px;
                margin-top: 20px;
            }

            .description-container {
                position: relative;
            }

            .description-preview {
                border: 2px solid var(--border);
                border-radius: var(--radius);
                padding: 16px;
                background: var(--white);
                min-height: 140px;
                font-family: Arial, sans-serif;
            }

            /* QR Grid Maker Styles */
            .qr-grid-section {
                background: var(--white);
                padding: 40px;
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-xl);
                border: 1px solid var(--border);
            }

            .qr-grid-section h2 {
                color: var(--primary);
                margin-bottom: 30px;
                text-align: center;
                font-size: 28px;
                font-weight: 700;
                position: relative;
                padding-bottom: 15px;
            }

            .qr-grid-section h2::after {
                content: '';
                position: absolute;
                bottom: 0;
                left: 50%;
                transform: translateX(-50%);
                width: 60px;
                height: 4px;
                background: linear-gradient(90deg, var(--primary), var(--secondary));
                border-radius: 2px;
            }

            .qr-grid-search {
                display: flex;
                gap: 12px;
                margin-bottom: 24px;
            }

            .qr-grid-search input {
                flex: 1;
                padding: 12px 16px;
                border: 2px solid var(--border);
                border-radius: var(--radius);
                font-size: 14px;
                transition: var(--transition);
            }

            .qr-grid-search input:focus {
                border-color: var(--primary);
                outline: none;
                box-shadow: 0 0 0 4px var(--primary-light);
            }

            .qr-grid-search button {
                padding: 12px 28px;
                background: linear-gradient(135deg, var(--info) 0%, var(--info-dark) 100%);
                color: white;
                border: none;
                border-radius: var(--radius);
                cursor: pointer;
                font-weight: 600;
                transition: var(--transition);
                box-shadow: var(--shadow);
            }

            .qr-grid-search button:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }

            .qr-grid-results {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
                gap: 16px;
                margin-bottom: 24px;
                max-height: 450px;
                overflow-y: auto;
                padding: 16px;
                border: 2px solid var(--border);
                border-radius: var(--radius);
                background: var(--light);
            }

            .qr-grid-item {
                background: var(--white);
                border: 2px solid var(--border);
                border-radius: var(--radius);
                padding: 16px;
                cursor: pointer;
                transition: var(--transition);
            }

            .qr-grid-item:hover {
                border-color: var(--info);
                transform: translateY(-2px);
                box-shadow: var(--shadow);
            }

            .qr-grid-item.selected {
                border-color: var(--secondary);
                background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
                box-shadow: var(--shadow);
            }

            .qr-grid-item-name {
                font-weight: 600;
                margin-bottom: 8px;
                color: var(--dark);
            }

            .qr-grid-item-code {
                font-size: 12px;
                color: var(--gray);
                background: var(--light);
                padding: 4px 8px;
                border-radius: 6px;
                display: inline-block;
                margin-top: 4px;
            }

            .qr-grid-controls {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 24px;
                margin-bottom: 24px;
            }

            .qr-grid-preview {
                border: 2px solid var(--border);
                border-radius: var(--radius);
                padding: 24px;
                background: var(--light);
                min-height: 350px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            .qr-grid-preview h3 {
                color: var(--primary);
                margin-bottom: 16px;
                font-weight: 700;
            }

            .qr-grid-slider {
                padding: 24px;
                background: var(--light);
                border-radius: var(--radius);
                border: 2px solid var(--border);
            }

            .qr-grid-slider h3 {
                color: var(--primary);
                margin-bottom: 20px;
                font-weight: 700;
            }

            .slider-container {
                margin-bottom: 20px;
            }

            .slider-label {
                display: flex;
                justify-content: space-between;
                margin-bottom: 10px;
                font-weight: 600;
            }

            .slider-value {
                font-weight: 700;
                color: var(--primary);
            }

            .size-slider {
                width: 100%;
                height: 8px;
                border-radius: 4px;
                background: var(--border);
                outline: none;
                -webkit-appearance: none;
                cursor: pointer;
            }

            .size-slider::-webkit-slider-thumb {
                -webkit-appearance: none;
                width: 24px;
                height: 24px;
                border-radius: 50%;
                background: linear-gradient(135deg, var(--info) 0%, var(--info-dark) 100%);
                cursor: pointer;
                box-shadow: var(--shadow);
                transition: var(--transition);
            }

            .size-slider::-webkit-slider-thumb:hover {
                transform: scale(1.1);
                box-shadow: var(--shadow-lg);
            }

            .size-slider::-moz-range-thumb {
                width: 24px;
                height: 24px;
                border-radius: 50%;
                background: linear-gradient(135deg, var(--info) 0%, var(--info-dark) 100%);
                cursor: pointer;
                box-shadow: var(--shadow);
                border: none;
                transition: var(--transition);
            }

            .size-slider::-moz-range-thumb:hover {
                transform: scale(1.1);
                box-shadow: var(--shadow-lg);
            }

            .qr-grid-stats {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 16px;
                margin-top: 20px;
            }

            .stat-box {
                background: var(--white);
                padding: 20px;
                border-radius: var(--radius);
                text-align: center;
                border: 2px solid var(--border);
                transition: var(--transition);
            }

            .stat-box:hover {
                border-color: var(--primary);
                transform: translateY(-2px);
                box-shadow: var(--shadow);
            }

            .stat-value {
                font-size: 32px;
                font-weight: 700;
                color: var(--primary);
                margin-bottom: 8px;
                line-height: 1;
            }

            .stat-label {
                font-size: 12px;
                color: var(--gray);
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .qr-grid-actions {
                display: flex;
                justify-content: center;
                gap: 16px;
                margin-top: 24px;
            }

            .generate-pdf-btn {
                padding: 14px 36px;
                background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
                color: white;
                border: none;
                border-radius: var(--radius);
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: var(--transition);
                box-shadow: var(--shadow);
            }

            .generate-pdf-btn:hover {
                transform: translateY(-3px);
                box-shadow: var(--shadow-xl);
            }

            .preview-grid {
                display: grid;
                gap: 12px;
                margin-top: 20px;
                justify-content: center;
            }

            .preview-qr {
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 12px;
                border: 2px dashed var(--border);
                border-radius: var(--radius-sm);
                background: var(--white);
                transition: var(--transition);
            }

            .preview-qr:hover {
                border-color: var(--primary);
            }

            .preview-qr canvas {
                max-width: 100%;
                height: auto;
            }

            .preview-label {
                font-size: 10px;
                margin-top: 6px;
                text-align: center;
                word-break: break-word;
                font-weight: 600;
                color: var(--dark);
            }

            /* QR Type Selector */
            .qr-type-selector {
                margin-bottom: 20px;
            }

            .qr-type-selector label {
                font-weight: 600;
                color: var(--dark);
                display: block;
                margin-bottom: 12px;
            }

            .qr-type-options {
                display: flex;
                gap: 12px;
                margin-top: 10px;
            }

            .qr-type-option {
                padding: 10px 20px;
                background: var(--white);
                border: 2px solid var(--border);
                border-radius: var(--radius);
                cursor: pointer;
                font-size: 13px;
                font-weight: 600;
                transition: var(--transition);
                flex: 1;
                text-align: center;
            }

            .qr-type-option:hover {
                border-color: var(--info);
                transform: translateY(-2px);
            }

            .qr-type-option.active {
                background: linear-gradient(135deg, var(--info) 0%, var(--info-dark) 100%);
                color: white;
                border-color: var(--info);
                box-shadow: var(--shadow);
            }

            /* A4 Preview Styles */
            .a4-preview-container {
                width: 595px;
                height: 842px;
                background: var(--white);
                border: 2px solid var(--border);
                margin: 20px auto;
                padding: 20px;
                box-shadow: var(--shadow-lg);
                position: relative;
                border-radius: var(--radius-sm);
            }

            .a4-grid-container {
                display: grid;
                width: 100%;
                height: 100%;
                gap: 12px;
                align-content: start;
            }

            .a4-qr-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                text-align: center;
                border: 2px solid var(--border);
                border-radius: var(--radius-sm);
                padding: 10px;
                background: var(--white);
                transition: var(--transition);
            }

            .a4-qr-item:hover {
                border-color: var(--primary);
                box-shadow: var(--shadow-sm);
            }

            .a4-qr-label {
                font-size: 9px;
                margin-top: 6px;
                word-break: break-word;
                max-width: 100%;
                line-height: 1.3;
                font-weight: 600;
                color: var(--dark);
            }

            .a4-qr-code-type {
                font-size: 8px;
                color: var(--gray);
                margin-top: 3px;
                font-weight: 500;
            }

            .qr-replicate-section {
                background: var(--white);
                padding: 16px;
                border-radius: var(--radius);
                border: 2px solid var(--border);
            }

            .qr-item-controls {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-top: 10px;
            }

            .quantity-input {
                width: 70px;
                padding: 6px 10px;
                border: 2px solid var(--border);
                border-radius: var(--radius-sm);
                font-size: 12px;
                text-align: center;
                font-weight: 600;
                transition: var(--transition);
            }

            .quantity-input:focus {
                border-color: var(--primary);
                outline: none;
                box-shadow: 0 0 0 3px var(--primary-light);
            }

            .remove-item-btn {
                background: linear-gradient(135deg, var(--danger) 0%, var(--danger-dark) 100%);
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: var(--radius-sm);
                cursor: pointer;
                font-size: 11px;
                font-weight: 600;
                transition: var(--transition);
                box-shadow: var(--shadow-sm);
            }

            .remove-item-btn:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow);
            }

            .print-btn {
                padding: 14px 36px;
                background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
                color: white;
                border: none;
                border-radius: var(--radius);
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: var(--transition);
                box-shadow: var(--shadow);
            }

            .print-btn:hover {
                transform: translateY(-3px);
                box-shadow: var(--shadow-xl);
            }

            /* Stock Manager Styles */
            .stock-type-selector {
                display: flex;
                gap: 12px;
                margin-bottom: 20px;
            }

            .stock-type-btn {
                padding: 12px 24px;
                background: var(--white);
                border: 2px solid var(--border);
                border-radius: var(--radius);
                cursor: pointer;
                font-weight: 600;
                transition: var(--transition);
                flex: 1;
                font-size: 14px;
            }

            .stock-type-btn:hover {
                border-color: var(--info);
                transform: translateY(-2px);
            }

            .stock-type-btn.active {
                background: linear-gradient(135deg, var(--info) 0%, var(--info-dark) 100%);
                color: white;
                border-color: var(--info);
                box-shadow: var(--shadow);
            }

            .stock-section {
                display: none;
            }

            .stock-section.active {
                display: block;
            }

            /* History Table Styles */
            .history-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 12px;
            }

            .history-table th,
            .history-table td {
                padding: 12px;
                text-align: left;
                border-bottom: 2px solid var(--border);
                font-size: 13px;
            }

            .history-table th {
                background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
                color: white;
                font-weight: 600;
                text-transform: uppercase;
                font-size: 12px;
                letter-spacing: 0.5px;
            }

            .history-table tr {
                transition: var(--transition);
            }

            .history-table tr:hover {
                background: var(--light);
            }

            .history-badge {
                padding: 4px 10px;
                border-radius: 16px;
                color: white;
                font-size: 11px;
                font-weight: bold;
                text-transform: uppercase;
                display: inline-block;
            }

            .history-badge.add {
                background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            }

            .history-badge.reduce {
                background: linear-gradient(135deg, var(--danger) 0%, var(--danger-dark) 100%);
            }

            /* Empty State */
            .empty-state {
                text-align: center;
                padding: 60px 20px;
                color: var(--gray);
                grid-column: 1 / -1;
            }

            .empty-state h3 {
                font-size: 22px;
                margin-bottom: 12px;
                color: var(--dark);
            }

            .empty-state p {
                font-size: 14px;
                color: var(--gray);
            }

            /* No Results State */
            .no-results {
                text-align: center;
                padding: 60px 20px;
                color: var(--gray);
                grid-column: 1 / -1;
            }

            .no-results h3 {
                font-size: 22px;
                margin-bottom: 12px;
                color: var(--danger);
            }

            .no-results p {
                font-size: 14px;
                color: var(--gray);
            }

            /* Variant Button Styles */
            .variant-btn {
                padding: 6px 12px;
                margin: 3px;
                background: linear-gradient(135deg, var(--info) 0%, var(--info-dark) 100%);
                color: white;
                border: none;
                border-radius: 20px;
                font-size: 11px;
                cursor: pointer;
                transition: var(--transition);
                font-weight: 600;
                box-shadow: var(--shadow-sm);
            }

            .variant-btn:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow);
            }

            .variant-btn.active {
                background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
                transform: scale(1.08);
                box-shadow: var(--shadow);
            }

            /* Variant Description Styles */
            .variant-description-field {
                margin-top: 16px;
            }

            .variant-description-editor .description-editor {
                background: #f5f5f5;
            }

            /* Variant Details Container */
            .variant-details-container {
                margin-top: 16px;
                padding: 16px;
                background: var(--light);
                border-radius: var(--radius);
                border: 2px solid var(--border);
            }

            /* Hide last two product-detail elements */
            .product-card .product-details .product-detail:nth-last-child(-n+2) {
                display: none;
            }

            /* Scrollbar Styling */
            ::-webkit-scrollbar {
                width: 10px;
                height: 10px;
            }

            ::-webkit-scrollbar-track {
                background: var(--light);
                border-radius: 5px;
            }

            ::-webkit-scrollbar-thumb {
                background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
                border-radius: 5px;
                transition: var(--transition);
            }

            ::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            }

            /* Responsive Design */
            @media (max-width: 1200px) {
                .content-section {
                    width: 90%;
                }
            }

            @media (max-width: 768px) {
                .content-section {
                    width: 100%;
                }

                .form-container,
                .items-container,
                .json-container,
                .qr-grid-section {
                    padding: 24px 16px;
                }

                .form-row {
                    grid-template-columns: 1fr;
                    gap: 16px;
                }

                .products-grid {
                    grid-template-columns: 1fr;
                    gap: 16px;
                }

                .nav-buttons {
                    flex-direction: column;
                    align-items: stretch;
                }

                .nav-btn {
                    width: 100%;
                }

                .json-header {
                    flex-direction: column;
                    align-items: stretch;
                }

                .copy-btn,
                .refresh-btn {
                    width: 100%;
                }

                .filter-section {
                    flex-direction: column;
                    align-items: stretch;
                }

                .search-bar-container {
                    min-width: auto;
                }

                .filter-controls {
                    flex-direction: column;
                    align-items: stretch;
                }

                .category-filter {
                    min-width: auto;
                }

                .form-actions {
                    flex-direction: column;
                }

                .product-actions {
                    grid-template-columns: 1fr 1fr;
                }

                .qr-modal-content,
                .batch-modal-content {
                    margin: 20px;
                }

                .qr-grid-controls {
                    grid-template-columns: 1fr;
                }

                .qr-grid-stats {
                    grid-template-columns: 1fr;
                }

                .editor-toolbar {
                    flex-direction: column;
                }

                .css-grid {
                    grid-template-columns: 1fr;
                }

                .qr-type-options {
                    flex-direction: column;
                }
            }

            @media (max-width: 480px) {
                .main-container {
                    padding: 20px 12px;
                }

                .form-container,
                .items-container,
                .json-container,
                .qr-grid-section {
                    padding: 20px 12px;
                }

                .product-card {
                    padding: 16px;
                }

                .product-header {
                    flex-direction: column;
                    gap: 10px;
                }

                #qrCodeCanvas canvas {
                    max-width: 100%;
                    height: auto;
                }

                .product-actions {
                    grid-template-columns: 1fr;
                }

                .editor-input-group {
                    flex-direction: column;
                }

                .a4-preview-container {
                    width: 100%;
                    height: auto;
                    aspect-ratio: 1/1.4142;
                }
            }

            /* Print Styles */
            @media print {
                body {
                    background: white;
                }

                .header,
                .nav-buttons,
                .filter-section,
                .product-actions,
                .form-actions {
                    display: none;
                }

                .content-section {
                    width: 100%;
                }
            }

            /* Sidebar Styles */
            .sidebar {
                position: fixed;
                left: -300px;
                top: 0;
                width: 280px;
                height: 100vh;
                background: rgba(255, 255, 255, 0.98);
                backdrop-filter: blur(10px);
                box-shadow: var(--shadow-xl);
                transition: var(--transition);
                z-index: 1000;
                padding: 20px;
                overflow-y: auto;
            }

            .sidebar.open {
                left: 0;
            }

            .sidebar-nav {
                display: flex;
                flex-direction: column;
                gap: 8px;
                margin-top: 60px;
            }

            .sidebar-btn {
                padding: 14px 20px;
                background: var(--white);
                color: var(--dark);
                border: 2px solid var(--border);
                border-radius: var(--radius);
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: var(--transition);
                text-align: left;
                width: 100%;
            }

            .sidebar-btn:hover {
                transform: translateX(5px);
                box-shadow: var(--shadow);
                border-color: var(--primary);
                color: var(--primary);
            }

            .sidebar-btn.active {
                background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
                border-color: var(--primary);
                color: var(--white);
                box-shadow: var(--shadow);
            }

            /* Toggle Button Styles */
            .menu-toggle {
                position: fixed;
                top: 20px;
                left: 20px;
                z-index: 1001;
                background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
                color: white;
                border: none;
                border-radius: var(--radius);
                width: 50px;
                height: 50px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 20px;
                box-shadow: var(--shadow-lg);
                transition: var(--transition);
            }

            .menu-toggle:hover {
                transform: scale(1.1);
                box-shadow: var(--shadow-xl);
            }

            /* Overlay for mobile */
            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                display: none;
            }

            .sidebar-overlay.active {
                display: block;
            }

            /* Adjust main container for sidebar */
            .main-container {
                margin-left: 0;
                transition: var(--transition);
            }

            /* .sidebar-open .main-container {
                margin-left: 280px;
            } */

            /* Responsive adjustments */
            @media (max-width: 768px) {
                .sidebar {
                    width: 100%;
                    left: -100%;
                }

                .sidebar-open .main-container {
                    margin-left: 0;
                }
            }

            .sidebar-btn[style*="var(--warning)"] {
                background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%) !important;
                color: white !important;
                border-color: var(--accent) !important;
            }

            /* Sort Order Button Styles */
            #sortOrderBtn {
                background: linear-gradient(135deg, var(--info) 0%, var(--info-dark) 100%);
                color: white;
                border: none;
                padding: 12px 16px;
                border-radius: var(--radius);
                cursor: pointer;
                font-size: 13px;
                font-weight: 600;
                transition: var(--transition);
                box-shadow: var(--shadow);
                min-width: 120px;
            }

            #sortOrderBtn:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }
        </style>
    </head>

<body>
    <!-- Sidebar Toggle Button -->
    <button class="menu-toggle" onclick="toggleSidebar()"></button>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-nav">
            <button class="sidebar-btn active" onclick="showSection('addItem')">Add Item</button>
            <button class="sidebar-btn" onclick="showSection('addedItems')">Added Items</button>
            <button class="sidebar-btn" onclick="showSection('jsonData')">JSON Data</button>
            <button class="sidebar-btn" onclick="showSection('qrGridMaker')"
                style="background: var(--accent); color: white; border-color: var(--accent);">QR Grid Maker</button>
            <button class="sidebar-btn" onclick="openBatchAdd()"
                style="background: var(--info); color: white; border-color: var(--info);">Batch Add</button>
            <button class="sidebar-btn" onclick="openStockManager()"
                style="background: var(--secondary); color: white; border-color: var(--secondary);">Stock
                Manager</button>
            <button class="sidebar-btn" onclick="openStockHistory()"
                style="background: var(--warning); color: white; border-color: var(--warning);">Stock History</button>
        </div>
    </div>

    <!-- Main Content Container -->
    <main class="main-container">
        <!-- Add Item Section -->
        <section id="addItem" class="content-section active">
            <div class="form-container">
                <h2 id="formTitle">Add New Product</h2>
                <form id="productForm" class="product-form">
                    <input type="hidden" id="editMode" value="false">
                    <input type="hidden" id="originalItemName">

                    <div class="form-group regular-field">
                        <label for="itemName">Item Name *</label>
                        <input type="text" id="itemName" name="itemName" required>
                    </div>

                    <div class="form-group regular-field">
                        <label for="productCode">Product Code *</label>
                        <input type="text" id="productCode" name="productCode" required
                            oninput="checkProductCodeDuplicate(this, 'product')">
                        <div class="duplicate-warning"
                            style="display: none; color: red; font-size: 12px; margin-top: 4px;">Product code already
                            exists</div>
                    </div>

                    <div class="form-group">
                        <label for="sectionName">Section Name</label>
                        <input type="text" id="sectionName" name="sectionName">
                    </div>

                    <div class="form-group">
                        <label for="sectionCode">Section Code</label>
                        <input type="text" id="sectionCode" name="sectionCode">
                    </div>

                    <div class="form-group regular-field">
                        <label for="imageUrls">Image URLs (comma separated)</label>
                        <input type="text" id="imageUrls" name="imageUrls" placeholder="image1.jpg, image2.jpg">
                    </div>

                    <div class="form-group regular-field">
                        <label for="sellPrice">Sell Price *</label>
                        <input type="number" id="sellPrice" name="sellPrice" step="0.01" required>
                    </div>

                    <div class="form-group regular-field">
                        <label for="mrp">MRP</label>
                        <input type="number" id="mrp" name="mrp" step="0.01" value="0">
                    </div>

                    <div class="form-row regular-field">
                        <div class="form-group">
                            <label for="unit">Unit *</label>
                            <input type="text" id="unit" required>
                        </div>

                        <div class="form-group">
                            <label for="packing">Packing *</label>
                            <input type="text" id="packing" required>
                        </div>
                    </div>

                    <div class="form-group regular-field">
                        <label for="brandName">Brand Name *</label>
                        <input type="text" id="brandName" required>
                    </div>

                    <div class="form-group regular-field">
                        <label for="inStock">In Stock *</label>
                        <input type="number" id="inStock" required>
                    </div>

                    <div class="form-group regular-field">
                        <label for="otherNames">Other Names (comma separated)</label>
                        <input type="text" id="otherNames" placeholder="name1, name2, name3">
                    </div>

                    <!-- Advanced Description Editor -->
                    <div class="form-group regular-field">
                        <label for="description">Description *</label>
                        <div class="description-editor">
                            <!-- Main Toolbar -->
                            <div class="editor-toolbar">
                                <button type="button" class="editor-btn" onclick="showTextPanel()">Add Text</button>
                                <button type="button" class="editor-btn" onclick="showListPanel()">Add List</button>
                                <button type="button" class="editor-btn" onclick="showHeadingPanel()">Heading</button>
                                <button type="button" class="editor-btn" onclick="addSimpleFormat('bold')">Bold</button>
                                <button type="button" class="editor-btn"
                                    onclick="addSimpleFormat('italic')">Italic</button>
                                <button type="button" class="editor-btn" onclick="addLineBreak()">Line Break</button>
                                <button type="button" class="editor-btn" onclick="showLinkPanel()">Link</button>
                                <button type="button" class="editor-btn" id="cssToggleBtn"
                                    onclick="toggleCssPanel()">CSS: OFF</button>
                                <button type="button" class="editor-btn" id="previewToggleBtn"
                                    onclick="togglePreview()">Preview: OFF</button>
                            </div>

                            <!-- Configuration Panels -->
                            <!-- Configuration Panels -->
                            <div id="configPanels">
                                <!-- Text Panel -->
                                <div id="textPanel" class="config-panel" style="display: none;">
                                    <h4>Add Text</h4>
                                    <div class="editor-input-group">
                                        <textarea id="textContent" class="editor-input" placeholder="Enter text content"
                                            rows="3"></textarea>
                                    </div>
                                    <div id="textCssPanel" class="css-panel" style="display: none;">
                                        <div class="css-grid">
                                            <div class="css-group">
                                                <label>Font Family:</label>
                                                <select id="textFontFamily">
                                                    <option value="">Default</option>
                                                    <option value="Arial, sans-serif">Arial</option>
                                                    <option value="Helvetica, sans-serif">Helvetica</option>
                                                    <option value="Times New Roman, serif">Times New Roman</option>
                                                    <option value="Georgia, serif">Georgia</option>
                                                    <option value="Courier New, monospace">Courier New</option>
                                                </select>
                                            </div>
                                            <div class="css-group">
                                                <label>Font Size:</label>
                                                <input type="text" id="textFontSize" placeholder="e.g., 16px, 1.2em">
                                            </div>
                                            <div class="css-group">
                                                <label>Font Weight:</label>
                                                <select id="textFontWeight">
                                                    <option value="">Normal</option>
                                                    <option value="bold">Bold</option>
                                                    <option value="100">100</option>
                                                    <option value="300">300</option>
                                                    <option value="400">400</option>
                                                    <option value="500">500</option>
                                                    <option value="700">700</option>
                                                    <option value="900">900</option>
                                                </select>
                                            </div>
                                            <div class="css-group">
                                                <label>Color:</label>
                                                <input type="color" id="textColor" value="#000000">
                                            </div>
                                            <div class="css-group">
                                                <label>Background:</label>
                                                <input type="color" id="textBgColor" value="#ffffff">
                                            </div>
                                            <div class="css-group">
                                                <label>Text Decoration:</label>
                                                <select id="textDecoration">
                                                    <option value="">None</option>
                                                    <option value="underline">Underline</option>
                                                    <option value="line-through">Line Through</option>
                                                    <option value="overline">Overline</option>
                                                </select>
                                            </div>
                                            <div class="css-group">
                                                <label>Text Transform:</label>
                                                <select id="textTransform">
                                                    <option value="">None</option>
                                                    <option value="uppercase">Uppercase</option>
                                                    <option value="lowercase">Lowercase</option>
                                                    <option value="capitalize">Capitalize</option>
                                                </select>
                                            </div>
                                            <div class="css-group">
                                                <label>Text Align:</label>
                                                <select id="textAlign">
                                                    <option value="">Left</option>
                                                    <option value="center">Center</option>
                                                    <option value="right">Right</option>
                                                    <option value="justify">Justify</option>
                                                </select>
                                            </div>
                                            <div class="css-group">
                                                <label>Line Height:</label>
                                                <input type="text" id="textLineHeight" placeholder="e.g., 1.5, 24px">
                                            </div>
                                            <div class="css-group">
                                                <label>Letter Spacing:</label>
                                                <input type="text" id="textLetterSpacing"
                                                    placeholder="e.g., 1px, 0.1em">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="panel-actions">
                                        <button type="button" class="editor-btn" onclick="addStyledText()">Add
                                            Text</button>
                                        <button type="button" class="cancel-btn"
                                            onclick="hideAllPanels()">Cancel</button>
                                    </div>
                                </div>

                                <!-- List Panel -->
                                <div id="listPanel" class="config-panel" style="display: none;">
                                    <h4>Add List</h4>
                                    <div class="editor-input-group">
                                        <label>List Type:</label>
                                        <select id="listType" onchange="toggleListStyleOptions()">
                                            <option value="ul">Unordered List (UL)</option>
                                            <option value="ol">Ordered List (OL)</option>
                                        </select>
                                    </div>
                                    <div id="listStyleOptions" class="editor-input-group">
                                        <label>List Style:</label>
                                        <select id="listStyle">
                                            <option value="disc">Disc</option>
                                            <option value="circle">Circle</option>
                                            <option value="square">Square</option>
                                        </select>
                                    </div>
                                    <div class="editor-input-group">
                                        <label>List Items (one per line):</label>
                                        <textarea id="listItems" class="editor-input"
                                            placeholder="Enter list items, one per line" rows="5"></textarea>
                                    </div>
                                    <div id="listCssPanel" class="css-panel" style="display: none;">
                                        <div class="css-grid">
                                            <div class="css-group">
                                                <label>Font Family:</label>
                                                <select id="listFontFamily">
                                                    <option value="">Default</option>
                                                    <option value="Arial, sans-serif">Arial</option>
                                                    <option value="Helvetica, sans-serif">Helvetica</option>
                                                    <option value="Times New Roman, serif">Times New Roman</option>
                                                </select>
                                            </div>
                                            <div class="css-group">
                                                <label>Font Size:</label>
                                                <input type="text" id="listFontSize" placeholder="e.g., 14px">
                                            </div>
                                            <div class="css-group">
                                                <label>Color:</label>
                                                <input type="color" id="listColor" value="#000000">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="panel-actions">
                                        <button type="button" class="editor-btn" onclick="addList()">Add List</button>
                                        <button type="button" class="cancel-btn"
                                            onclick="hideAllPanels()">Cancel</button>
                                    </div>
                                </div>

                                <!-- Heading Panel -->
                                <div id="headingPanel" class="config-panel" style="display: none;">
                                    <h4>Add Heading</h4>
                                    <div class="editor-input-group">
                                        <label>Heading Level:</label>
                                        <select id="headingLevel">
                                            <option value="h1">H1</option>
                                            <option value="h2">H2</option>
                                            <option value="h3">H3</option>
                                            <option value="h4">H4</option>
                                            <option value="h5">H5</option>
                                            <option value="h6">H6</option>
                                        </select>
                                    </div>
                                    <div class="editor-input-group">
                                        <label>Heading Text:</label>
                                        <input type="text" id="headingText" class="editor-input"
                                            placeholder="Enter heading text">
                                    </div>
                                    <div id="headingCssPanel" class="css-panel" style="display: none;">
                                        <div class="css-grid">
                                            <div class="css-group">
                                                <label>Color:</label>
                                                <input type="color" id="headingColor" value="#000000">
                                            </div>
                                            <div class="css-group">
                                                <label>Text Align:</label>
                                                <select id="headingAlign">
                                                    <option value="">Left</option>
                                                    <option value="center">Center</option>
                                                    <option value="right">Right</option>
                                                </select>
                                            </div>
                                            <div class="css-group">
                                                <label>Font Weight:</label>
                                                <select id="headingFontWeight">
                                                    <option value="bold">Bold</option>
                                                    <option value="normal">Normal</option>
                                                    <option value="300">Light</option>
                                                    <option value="700">Bolder</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="panel-actions">
                                        <button type="button" class="editor-btn" onclick="addHeading()">Add
                                            Heading</button>
                                        <button type="button" class="cancel-btn"
                                            onclick="hideAllPanels()">Cancel</button>
                                    </div>
                                </div>

                                <!-- Link Panel -->
                                <div id="linkPanel" class="config-panel" style="display: none;">
                                    <h4>Add Link</h4>
                                    <div class="editor-input-group">
                                        <label>URL:</label>
                                        <input type="text" id="linkUrl" class="editor-input"
                                            placeholder="https://example.com">
                                    </div>
                                    <div class="editor-input-group">
                                        <label>Link Text:</label>
                                        <input type="text" id="linkText" class="editor-input" placeholder="Click here">
                                    </div>
                                    <div class="editor-input-group">
                                        <label>Target:</label>
                                        <select id="linkTarget">
                                            <option value="_self">Same Tab</option>
                                            <option value="_blank">New Tab</option>
                                        </select>
                                    </div>
                                    <div id="linkCssPanel" class="css-panel" style="display: none;">
                                        <div class="css-grid">
                                            <div class="css-group">
                                                <label>Link Color:</label>
                                                <input type="color" id="linkColor" value="#0000ff">
                                            </div>
                                            <div class="css-group">
                                                <label>Text Decoration:</label>
                                                <select id="linkDecoration">
                                                    <option value="underline">Underline</option>
                                                    <option value="none">None</option>
                                                    <option value="overline">Overline</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="panel-actions">
                                        <button type="button" class="editor-btn" onclick="addLink()">Add Link</button>
                                        <button type="button" class="cancel-btn"
                                            onclick="hideAllPanels()">Cancel</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Description Textarea/Preview -->
                            <div class="description-container">
                                <textarea id="description" rows="5" data-was-required="true" required="true"
                                    style="display: block; width: 100%;"></textarea>
                                <div id="descriptionPreview" class="description-preview" style="display: none;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group regular-field">
                        <label for="category">Category *</label>
                        <input type="text" id="category" required>
                    </div>

                    <!-- Variant Section -->
                    <div class="variant-section">
                        <div class="variant-toggle">
                            <input type="checkbox" id="hasVariants" onchange="toggleVariants()">
                            <label for="hasVariants" style="font-weight: 600; cursor: pointer;">This product has
                                variants</label>
                        </div>

                        <div id="variantsContainer" class="variants-container">
                            <div class="form-group" style="flex-direction: row;margin-bottom: 10px;">
                                <label for="showVariantName" style="margin-right: 20px;">Show variant name in product
                                    display</label>
                                <input type="checkbox" id="showVariantName">
                            </div>

                            <div id="variantsList"></div>

                            <button type="button" class="add-variant-btn" onclick="addVariant()">
                                + Add Variant
                            </button>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="submit-btn" id="submitBtn">Add Product</button>
                        <button type="button" class="cancel-btn" id="cancelBtn" onclick="cancelEdit()"
                            style="display: none;">Cancel Edit</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Added Items Section -->
        <section id="addedItems" class="content-section">
            <div class="items-container">
                <h2>Added Products</h2>
                <!-- Search and Filter Section -->
                <div class="filter-section">
                    <div class="search-bar-container">
                        <input type="text" id="searchInput" class="search-bar"
                            placeholder=" Search products by name, code, brand...">
                    </div>
                    <div class="filter-controls">
                        <select id="categoryFilter" class="category-filter">
                            <option value="all">All Categories</option>
                        </select>
                        <select id="sortBy" class="category-filter" onchange="applySorting()">
                            <option value="none">Sort by: None</option>
                            <option value="name">Name</option>
                            <option value="productCode">Product Code</option>
                            <option value="itemName">Item Name</option>
                            <option value="sectionCode">Section Code</option>
                            <option value="sectionName">Section Name</option>
                            <option value="cardType">Card Type</option>
                        </select>
                        <button id="sortOrderBtn" class="clear-filters-btn" onclick="toggleSortOrder()"
                            style="display: none;">
                             Ascending
                        </button>
                        <button class="clear-filters-btn" onclick="clearFilters()">Clear Filters</button>
                    </div>
                </div>

                <div id="productsGrid" class="products-grid"></div>
            </div>
        </section>

        <!-- JSON Data Section -->
        <section id="jsonData" class="content-section">
            <div class="json-container">
                <h2>Products JSON Data</h2>
                <div class="json-header">
                    <button onclick="copyToClipboard()" class="copy-btn">Copy JSON</button>
                    <button onclick="refreshJSON()" class="refresh-btn">Refresh</button>
                </div>
                <pre id="jsonOutput" class="json-output"></pre>
            </div>
        </section>

        <!-- QR Grid Maker Section -->
        <section id="qrGridMaker" class="content-section">
            <div class="qr-grid-section">
                <h2>QR Grid Maker</h2>

                <!-- QR Type Selector -->
                <div class="qr-type-selector">
                    <label>Select QR Code Type:</label>
                    <div class="qr-type-options">
                        <div class="qr-type-option active" data-type="product" onclick="selectQRType('product')">Product
                            QR</div>
                        <div class="qr-type-option" data-type="section" onclick="selectQRType('section')">Section QR
                        </div>
                        <div class="qr-type-option" data-type="variant" onclick="selectQRType('variant')">Variant QR
                        </div>
                    </div>
                </div>

                <div class="qr-grid-search">
                    <input type="text" id="qrGridSearch" placeholder=" Search products..." class="search-bar"
                        oninput="searchProductsForQRGrid()">
                    <button onclick="searchProductsForQRGrid()" class="submit-btn">Search</button>
                </div>

                <div id="qrGridResults" class="qr-grid-results">
                    <div class="empty-state">
                        <h3>No Products Found</h3>
                        <p>Search for products to generate QR codes</p>
                    </div>
                </div>

                <!-- Replace the entire qr-grid-controls section with this: -->
                <div class="qr-grid-controls">
                    <div class="qr-grid-preview">
                        <h3>A4 Preview</h3>
                        <div id="a4PreviewContainer" class="a4-preview-container">
                            <div id="a4GridContainer" class="a4-grid-container">
                                <div class="empty-state">
                                    <p>Select products and adjust settings to see preview</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="qr-grid-slider">
                        <h3>QR Code Settings</h3>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>QR Code Size:</span>
                                <span id="qrSizeValue" class="slider-value">100px</span>
                            </div>
                            <input type="range" min="50" max="200" value="100" class="size-slider" id="qrSizeSlider"
                                oninput="updateQRGridPreview()">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>QR Codes Per Row:</span>
                                <span id="qrPerRowValue" class="slider-value">4</span>
                            </div>
                            <input type="range" min="1" max="8" value="4" class="size-slider" id="qrPerRowSlider"
                                oninput="updateQRGridPreview()">
                        </div>

                        <div class="qr-grid-stats">
                            <div class="stat-box">
                                <div class="stat-value" id="qrPerRow">0</div>
                                <div class="stat-label">Per Row</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="qrPerColumn">0</div>
                                <div class="stat-label">Per Column</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="totalQRCodes">0</div>
                                <div class="stat-label">Total</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="qr-grid-actions">
                    <button class="generate-pdf-btn" onclick="generateQRPDF()">Generate PDF</button>
                    <button class="print-btn" onclick="printQRGrid()">Print</button>
                </div>
            </div>
        </section>
    </main>

    <!-- QR Code Modal -->
    <div class="modal" id="qrModal">
        <div class="modal-content qr-modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="qrModalTitle"> Product QR Code</h3>
                <button class="close-btn" onclick="closeQRModal()"></button>
            </div>
            <div class="qr-container">
                <div id="qrCodeCanvas"></div>
                <p class="qr-info" id="qrCodeInfo">Scan this QR code to quickly access product information</p>
                <div class="qr-actions">
                    <button class="download-btn" onclick="downloadQRCode()">
                        <span class="download-icon"></span>
                        Download QR Code
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Batch Add Modal -->
    <div class="modal" id="batchModal">
        <div class="modal-content batch-modal-content">
            <div class="modal-header">
                <h3 class="modal-title"> Batch Add Products</h3>
                <button class="close-btn" onclick="closeBatchModal()"></button>
            </div>
            <div class="batch-info">
                <strong>Format:</strong> Paste your products in JSON format. Example:
                <br>"Product Name": { "productCode": "CODE123", "price": "100", ... }
            </div>
            <textarea id="batchInput" class="batch-textarea"
                placeholder='Paste your products JSON here...&#10;&#10;Example:&#10;"13 x 6 nickel screw": {&#10;    "productCode": "NICKEL13X6",&#10;    "price": "320",&#10;    "category": "Screws"&#10;    ...&#10;}'></textarea>
            <div style="display: flex; gap: 10px;">
                <button class="submit-btn" onclick="processBatchAdd()" style="flex: 1;">Add Products</button>
                <button class="cancel-btn" onclick="closeBatchModal()">Cancel</button>
            </div>
        </div>
    </div>
    <!-- Stock Manager Modal -->
    <div class="modal" id="stockModal">
        <div class="modal-content batch-modal-content">
            <div class="modal-header">
                <h3 class="modal-title"> Stock Manager</h3>
                <button class="close-btn" onclick="closeStockModal()"></button>
            </div>
            <div class="batch-info">
                <strong>Format:</strong> [productCode@qty, productCode@qty, ..., customerNumber, customerName]
                <br><strong>Example:</strong> [111@4, 112@3, 113@4, 114@3, 9890147531, Asura Redoc]
            </div>

            <div class="stock-type-selector">
                <button class="stock-type-btn active" onclick="showStockType('add')">Add Stock</button>
                <button class="stock-type-btn" onclick="showStockType('reduce')">Reduce Stock</button>
            </div>

            <div id="addStockSection" class="stock-section active">
                <textarea id="addStockInput" class="batch-textarea"
                    placeholder="Enter products to add stock...&#10;Example: [111@4, 112@3, 9890147531, Customer Name]"></textarea>
            </div>

            <div id="reduceStockSection" class="stock-section" style="display: none;">
                <textarea id="reduceStockInput" class="batch-textarea"
                    placeholder="Enter products to reduce stock...&#10;Example: [111@4, 112@3, 9890147531, Customer Name]"></textarea>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="submit-btn" onclick="processStockOperation()" style="flex: 1;">Confirm</button>
                <button class="cancel-btn" onclick="closeStockModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Stock History Modal -->
    <div class="modal" id="historyModal">
        <div class="modal-content batch-modal-content">
            <div class="modal-header">
                <h3 class="modal-title"> Stock History</h3>
                <button class="close-btn" onclick="closeHistoryModal()"></button>
            </div>

            <div id="historyTableContainer" style="max-height: 400px; overflow-y: auto;">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Sr No</th>
                            <th>Transaction Data</th>
                            <th>Type</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <!-- History will be populated here -->
                    </tbody>
                </table>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 15px; justify-content: center;">
                <button class="submit-btn" onclick="printHistory()">Print History</button>
                <button class="cancel-btn" onclick="closeHistoryModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification hidden">
        <span id="notificationMessage"></span>
    </div>

    <script>
        // Database name and version - Changed to avoid conflicts
        const DB_NAME = 'ProductManagerDB';
        const STORE_NAME = 'products';

        // Global products object
        let PRODUCTS = {};
        let currentEditProduct = null;
        let allCategories = new Set();
        let currentQRProduct = null;
        let currentQRType = null; // 'section' or 'product'
        let selectedQRProducts = []; // Now stores objects with itemId and quantity
        let qrGridPreviewData = [];
        let currentCssEnabled = false;
        let previewEnabled = false;
        let currentQRGridType = 'product'; // Default QR type for grid
        let currentSortField = 'none';
        let currentSortOrder = 'asc';

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function () {
            loadProducts();
            setupForm();
            setupSearchAndFilter();

            // Close modal when clicking outside
            document.addEventListener('click', function (event) {
                const qrModal = document.getElementById('qrModal');
                const batchModal = document.getElementById('batchModal');
                const stockModal = document.getElementById('stockModal');
                const historyModal = document.getElementById('historyModal');
                if (event.target === qrModal) closeQRModal();
                if (event.target === batchModal) closeBatchModal();
                if (event.target === stockModal) closeStockModal();
                if (event.target === historyModal) closeHistoryModal();
            });
        });

        // Database functions - Fixed to handle version conflicts
        function getDatabase() {
            return new Promise((resolve, reject) => {
                // Open without specifying version to get current version
                const request = indexedDB.open(DB_NAME);

                request.onerror = () => reject(request.error);

                request.onsuccess = () => {
                    const db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'itemName' });
                        console.log('Products store created');
                    }
                };
            });
        }

        async function loadProducts() {
            try {
                const db = await getDatabase();

                // Check if store exists
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    console.log('Store does not exist, starting fresh');
                    PRODUCTS = {};
                    displayProducts();
                    updateJSONOutput();
                    updateCategoryFilter();
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();

                request.onsuccess = (event) => {
                    PRODUCTS = {};
                    allCategories.clear();

                    event.target.result.forEach(product => {
                        PRODUCTS[product.itemName] = product;
                        allCategories.add(product.category);
                    });

                    displayProducts();
                    updateJSONOutput();
                    updateCategoryFilter();
                    console.log('Products loaded successfully:', Object.keys(PRODUCTS).length);
                };

                request.onerror = (event) => {
                    console.error('Error loading products:', event.target.error);
                    // Start with empty products on error
                    PRODUCTS = {};
                    displayProducts();
                    updateJSONOutput();
                    updateCategoryFilter();
                };

            } catch (error) {
                console.error('Database access error:', error);
                // Start with empty products on any error
                PRODUCTS = {};
                displayProducts();
                updateJSONOutput();
                updateCategoryFilter();
            }
        }

        async function saveProduct(productData) {
            try {
                const db = await getDatabase();

                // Ensure store exists
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    // If store doesn't exist, we can't save - just update memory
                    PRODUCTS[productData.itemName] = productData;
                    allCategories.add(productData.category);
                    displayProducts();
                    updateJSONOutput();
                    updateCategoryFilter();
                    showNotification('Product saved to memory (database not ready)', 'warning');
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);

                await store.put(productData);

                PRODUCTS[productData.itemName] = productData;
                allCategories.add(productData.category);
                displayProducts();
                updateJSONOutput();
                updateCategoryFilter();

                const isEdit = document.getElementById('editMode').value === 'true';
                showNotification(`Product ${isEdit ? 'updated' : 'added'} successfully!`, 'success');

                if (isEdit) {
                    cancelEdit();
                } else {
                    clearForm();
                }

            } catch (error) {
                console.error('Error saving product:', error);
                showNotification('Error saving product to database', 'error');
            }
        }

        async function deleteProduct(itemName) {
            if (!confirm('Are you sure you want to delete this product?')) {
                return;
            }

            try {
                const db = await getDatabase();
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);

                const request = store.delete(itemName);

                request.onsuccess = function () {
                    const deletedProduct = PRODUCTS[itemName];
                    delete PRODUCTS[itemName];

                    // Update categories if this was the last product in that category
                    updateCategories();

                    displayProducts();
                    updateJSONOutput();
                    showNotification('Product deleted successfully!', 'success');
                };

                request.onerror = function (event) {
                    console.error('Error deleting product:', event.target.error);
                    showNotification('Error deleting product', 'error');
                };
            } catch (error) {
                console.error('Error deleting product:', error);
                showNotification('Error deleting product', 'error');
            }
        }

        function toggleVariants() {
            const hasVariants = document.getElementById('hasVariants').checked;
            const variantsContainer = document.getElementById('variantsContainer');
            const regularFields = document.querySelectorAll('.regular-field');

            if (hasVariants) {
                variantsContainer.classList.add('show');
                // Hide regular product fields and remove required attributes
                regularFields.forEach(field => {
                    if (!field.querySelector('#itemName')) { // Keep itemName field visible
                        field.style.display = 'none';
                        const inputs = field.querySelectorAll('input, textarea, select');
                        inputs.forEach(input => {
                            input.removeAttribute('required');
                            input.setAttribute('data-was-required', 'true'); // Store that it was required
                        });
                    }
                });
                // Show only variant-specific required fields
                document.getElementById('sectionName').closest('.form-group').style.display = 'flex';
                document.getElementById('sectionCode').closest('.form-group').style.display = 'flex';
                document.getElementById('productCode').closest('.form-group').style.display = 'flex';
                document.getElementById('category').closest('.form-group').style.display = 'flex';

                // Add first variant if none exist
                if (document.getElementById('variantsList').children.length === 0) {
                    addVariant();
                }
            } else {
                variantsContainer.classList.remove('show');
                // Show all regular fields and restore required attributes
                regularFields.forEach(field => {
                    field.style.display = 'flex';
                    const inputs = field.querySelectorAll('input, textarea, select');
                    inputs.forEach(input => {
                        if (input.getAttribute('data-was-required') === 'true') {
                            input.setAttribute('required', 'true');
                        }
                    });
                });
                document.getElementById('variantsList').innerHTML = '';
            }
        }

        function addVariant() {
            const variantsList = document.getElementById('variantsList');
            const variantId = 'variant_' + Date.now();
            const variantNumber = variantsList.children.length + 1;

            const variantHTML = `
        <div class="variant-item" id="${variantId}">
            <div class="variant-header">
                <div class="variant-name">Variant ${variantNumber}</div>
                <button type="button" class="remove-variant-btn" onclick="removeVariant('${variantId}')">Remove</button>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Variant Name *</label>
                    <input type="text" class="variant-name-input" placeholder="e.g., 100ml, 200ml" required>
                </div>
                <div class="form-group">
                    <label>Product Code *</label>
                    <input type="text" class="variant-code-input" required oninput="checkProductCodeDuplicate(this, 'variant')">
                    <div class="duplicate-warning" style="display: none; color: red; font-size: 12px; margin-top: 4px;">Product code already exists</div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Brand Name *</label>
                    <input type="text" class="variant-brand-input" required>
                </div>
                <div class="form-group">
                    <label>Category *</label>
                    <input type="text" class="variant-category-input" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Sell Price *</label>
                    <input type="number" class="variant-sellprice-input" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>MRP</label>
                    <input type="number" class="variant-mrp-input" step="0.01" value="0">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Unit *</label>
                    <input type="text" class="variant-unit-input" required>
                </div>
                <div class="form-group">
                    <label>Packing *</label>
                    <input type="text" class="variant-packing-input" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>In Stock *</label>
                    <input type="number" class="variant-stock-input" required>
                </div>
                <div class="form-group">
                    <label>Image URLs (comma separated)</label>
                    <input type="text" class="variant-image-input" placeholder="image1.jpg, image2.jpg">
                </div>
            </div>
            <div class="form-group">
                <label>Other Names (comma separated)</label>
                <input type="text" class="variant-othernames-input" placeholder="name1, name2, name3">
            </div>
            <div class="form-group variant-description-field">
                <label>Description *</label>
                <div class="description-editor variant-description-editor">
                    <!-- Main Toolbar -->
                    <div class="editor-toolbar">
                        <button type="button" class="editor-btn" onclick="showTextPanelForVariant('${variantId}')">Add Text</button>
                        <button type="button" class="editor-btn" onclick="showListPanelForVariant('${variantId}')">Add List</button>
                        <button type="button" class="editor-btn" onclick="showHeadingPanelForVariant('${variantId}')">Heading</button>
                        <button type="button" class="editor-btn" onclick="addSimpleFormatForVariant('bold', '${variantId}')">Bold</button>
                        <button type="button" class="editor-btn" onclick="addSimpleFormatForVariant('italic', '${variantId}')">Italic</button>
                        <button type="button" class="editor-btn" onclick="addLineBreakForVariant('${variantId}')">Line Break</button>
                        <button type="button" class="editor-btn" onclick="showLinkPanelForVariant('${variantId}')">Link</button>
                        <button type="button" class="editor-btn" id="cssToggleBtn_${variantId}" onclick="toggleCssPanelForVariant('${variantId}')">CSS: OFF</button>
                        <button type="button" class="editor-btn" id="previewToggleBtn_${variantId}" onclick="togglePreviewForVariant('${variantId}')">Preview: OFF</button>
                    </div>

                    <!-- Configuration Panels Container -->
                    <div id="configPanels_${variantId}">
                        <!-- Panels will be dynamically created when needed -->
                    </div>

                    <!-- Description Textarea/Preview -->
                    <div class="description-container">
                        <textarea class="variant-description-input" rows="5" required style="display: block;"></textarea>
                        <div class="description-preview" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    `;

            variantsList.insertAdjacentHTML('beforeend', variantHTML);
        }

        function removeVariant(variantId) {
            const variantElement = document.getElementById(variantId);
            if (variantElement) {
                variantElement.remove();
                // Reorder the remaining variants
                reorderVariants();
            }
        }

        function reorderVariants() {
            const variantsList = document.getElementById('variantsList');
            const variantItems = variantsList.querySelectorAll('.variant-item');

            variantItems.forEach((item, index) => {
                const variantNumber = index + 1;
                const variantNameElement = item.querySelector('.variant-name');
                if (variantNameElement) {
                    variantNameElement.textContent = `Variant ${variantNumber}`;
                }
            });
        }

        function getVariantsData() {
            const variants = {};
            const variantItems = document.querySelectorAll('.variant-item');

            variantItems.forEach(item => {
                const name = item.querySelector('.variant-name-input').value.trim();
                if (name) {
                    variants[name] = {
                        itemName: name,
                        productCode: item.querySelector('.variant-code-input').value.trim(),
                        image: item.querySelector('.variant-image-input').value
                            .split(',')
                            .map(url => url.trim())
                            .filter(url => url !== '') || ['default-product.jpg'],
                        sellPrice: item.querySelector('.variant-sellprice-input').value,
                        mrp: item.querySelector('.variant-mrp-input').value || '0',
                        unit: item.querySelector('.variant-unit-input').value.trim(),
                        packing: item.querySelector('.variant-packing-input').value.trim(),
                        brandName: item.querySelector('.variant-brand-input').value.trim(),
                        inStock: item.querySelector('.variant-stock-input').value,
                        otherName: item.querySelector('.variant-othernames-input').value
                            .split(',')
                            .map(name => name.trim())
                            .filter(name => name !== ''),
                        description: item.querySelector('.variant-description-input').value.trim(),
                        category: item.querySelector('.variant-category-input').value.trim()
                    };
                }
            });

            return variants;
        }

        // Advanced Description Editor Functions
        function hideAllPanels() {
            document.querySelectorAll('.config-panel').forEach(panel => {
                panel.style.display = 'none';
            });
        }

        function showPanel(panelId) {
            hideAllPanels();
            document.getElementById(panelId).style.display = 'block';
            updateCssPanels();
        }

        function showTextPanel() { showPanel('textPanel'); }
        function showListPanel() {
            showPanel('listPanel');
            toggleListStyleOptions();
        }
        function showHeadingPanel() { showPanel('headingPanel'); }
        function showLinkPanel() { showPanel('linkPanel'); }

        // CSS Toggle
        function toggleCssPanel() {
            currentCssEnabled = !currentCssEnabled;
            const btn = document.getElementById('cssToggleBtn');
            btn.textContent = `CSS: ${currentCssEnabled ? 'ON' : 'OFF'}`;
            updateCssPanels();
        }

        function updateCssPanels() {
            const cssPanels = document.querySelectorAll('.css-panel');
            cssPanels.forEach(panel => {
                panel.style.display = currentCssEnabled ? 'block' : 'none';
            });
        }

        // List Style Options
        function toggleListStyleOptions() {
            const listType = document.getElementById('listType').value;
            const styleOptions = document.getElementById('listStyleOptions');
            const listStyle = document.getElementById('listStyle');

            if (listType === 'ul') {
                listStyle.innerHTML = `
                <option value="disc">Disc</option>
                <option value="circle">Circle</option>
                <option value="square">Square</option>
                <option value="none">None</option>
            `;
            } else {
                listStyle.innerHTML = `
                <option value="decimal">Decimal</option>
                <option value="lower-alpha">Lower Alpha</option>
                <option value="upper-alpha">Upper Alpha</option>
                <option value="lower-roman">Lower Roman</option>
                <option value="upper-roman">Upper Roman</option>
            `;
            }
        }

        // Preview Toggle
        function togglePreview() {
            previewEnabled = !previewEnabled;
            const textarea = document.getElementById('description');
            const preview = document.getElementById('descriptionPreview');

            if (previewEnabled) {
                textarea.style.display = 'none';
                preview.style.display = 'block';
                updatePreview();
            } else {
                textarea.style.display = 'block';
                preview.style.display = 'none';
            }

            document.getElementById('previewToggleBtn').textContent = `Preview: ${previewEnabled ? 'ON' : 'OFF'}`;
        }

        function updatePreview() {
            const textarea = document.getElementById('description');
            const preview = document.getElementById('descriptionPreview');
            preview.innerHTML = textarea.value;
        }

        // Insert functions
        function insertAtCursor(textarea, text) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const value = textarea.value;

            textarea.value = value.substring(0, start) + text + value.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + text.length;
            textarea.focus();

            if (previewEnabled) {
                updatePreview();
            }
        }

        function addStyledText() {
            const content = document.getElementById('textContent').value;
            if (!content) return;

            let style = '';
            if (currentCssEnabled) {
                const styles = [
                    document.getElementById('textFontFamily').value ? `font-family: ${document.getElementById('textFontFamily').value}` : '',
                    document.getElementById('textFontSize').value ? `font-size: ${document.getElementById('textFontSize').value}` : '',
                    document.getElementById('textFontWeight').value ? `font-weight: ${document.getElementById('textFontWeight').value}` : '',
                    document.getElementById('textColor').value !== '#000000' ? `color: ${document.getElementById('textColor').value}` : '',
                    document.getElementById('textBgColor').value !== '#ffffff' ? `background-color: ${document.getElementById('textBgColor').value}` : '',
                    document.getElementById('textDecoration').value ? `text-decoration: ${document.getElementById('textDecoration').value}` : '',
                    document.getElementById('textTransform').value ? `text-transform: ${document.getElementById('textTransform').value}` : '',
                    document.getElementById('textAlign').value ? `text-align: ${document.getElementById('textAlign').value}` : '',
                    document.getElementById('textLineHeight').value ? `line-height: ${document.getElementById('textLineHeight').value}` : '',
                    document.getElementById('textLetterSpacing').value ? `letter-spacing: ${document.getElementById('textLetterSpacing').value}` : ''
                ].filter(s => s !== '').join('; ');

                if (styles) {
                    style = ` style="${styles}"`;
                }
            }

            const html = `<span${style}>${content}</span>`;
            insertAtCursor(document.getElementById('description'), html);
            hideAllPanels();
        }

        function addList() {
            const listType = document.getElementById('listType').value;
            const listStyle = document.getElementById('listStyle').value;
            const items = document.getElementById('listItems').value.split('\n').filter(item => item.trim() !== '');

            if (items.length === 0) return;

            let style = '';
            if (currentCssEnabled) {
                const styles = [
                    document.getElementById('listFontFamily').value ? `font-family: ${document.getElementById('listFontFamily').value}` : '',
                    document.getElementById('listFontSize').value ? `font-size: ${document.getElementById('listFontSize').value}` : '',
                    document.getElementById('listColor').value !== '#000000' ? `color: ${document.getElementById('listColor').value}` : ''
                ].filter(s => s !== '').join('; ');

                if (styles) {
                    style = ` style="${styles}"`;
                }
            }

            const listStyleAttr = listStyle ? ` style="list-style-type: ${listStyle}"` : '';
            let html = `<${listType}${listStyleAttr}${style}>\n`;
            items.forEach(item => {
                html += `  <li>${item}</li>\n`;
            });
            html += `</${listType}>`;

            insertAtCursor(document.getElementById('description'), html);
            hideAllPanels();
        }

        function addHeading() {
            const level = document.getElementById('headingLevel').value;
            const text = document.getElementById('headingText').value;
            if (!text) return;

            let style = '';
            if (currentCssEnabled) {
                const styles = [
                    document.getElementById('headingColor').value !== '#000000' ? `color: ${document.getElementById('headingColor').value}` : '',
                    document.getElementById('headingAlign').value ? `text-align: ${document.getElementById('headingAlign').value}` : '',
                    document.getElementById('headingFontWeight').value ? `font-weight: ${document.getElementById('headingFontWeight').value}` : ''
                ].filter(s => s !== '').join('; ');

                if (styles) {
                    style = ` style="${styles}"`;
                }
            }

            const html = `<${level}${style}>${text}</${level}>`;
            insertAtCursor(document.getElementById('description'), html);
            hideAllPanels();
        }

        function addLink() {
            const url = document.getElementById('linkUrl').value;
            const text = document.getElementById('linkText').value || url;
            const target = document.getElementById('linkTarget').value;

            if (!url) return;

            let style = '';
            if (currentCssEnabled) {
                const styles = [
                    document.getElementById('linkColor').value !== '#0000ff' ? `color: ${document.getElementById('linkColor').value}` : '',
                    document.getElementById('linkDecoration').value ? `text-decoration: ${document.getElementById('linkDecoration').value}` : ''
                ].filter(s => s !== '').join('; ');

                if (styles) {
                    style = ` style="${styles}"`;
                }
            }

            const html = `<a href="${url}" target="${target}"${style}>${text}</a>`;
            insertAtCursor(document.getElementById('description'), html);
            hideAllPanels();
        }

        function addSimpleFormat(type) {
            const formats = {
                'bold': ['<strong>', '</strong>'],
                'italic': ['<em>', '</em>'],
                'lineBreak': ['<br>', '']
            };

            const [startTag, endTag] = formats[type];
            insertAtCursor(document.getElementById('description'), `${startTag}${endTag}`);
        }

        function addLineBreak() {
            addSimpleFormat('lineBreak');
        }


        // NEW : Variant editor functions START
        // Variant Description Editor Functions
        function showTextPanelForVariant(variantId) {
            const panelId = `textPanel_${variantId}`;
            let panel = document.getElementById(panelId);

            if (!panel) {
                panel = createTextPanelForVariant(variantId);
                document.getElementById(`configPanels_${variantId}`).appendChild(panel);
            }

            hideAllVariantPanels(variantId);
            panel.style.display = 'block';
        }

        function showListPanelForVariant(variantId) {
            const panelId = `listPanel_${variantId}`;
            let panel = document.getElementById(panelId);

            if (!panel) {
                panel = createListPanelForVariant(variantId);
                document.getElementById(`configPanels_${variantId}`).appendChild(panel);
            }

            hideAllVariantPanels(variantId);
            panel.style.display = 'block';
        }

        function showHeadingPanelForVariant(variantId) {
            const panelId = `headingPanel_${variantId}`;
            let panel = document.getElementById(panelId);

            if (!panel) {
                panel = createHeadingPanelForVariant(variantId);
                document.getElementById(`configPanels_${variantId}`).appendChild(panel);
            }

            hideAllVariantPanels(variantId);
            panel.style.display = 'block';
        }

        function showLinkPanelForVariant(variantId) {
            const panelId = `linkPanel_${variantId}`;
            let panel = document.getElementById(panelId);

            if (!panel) {
                panel = createLinkPanelForVariant(variantId);
                document.getElementById(`configPanels_${variantId}`).appendChild(panel);
            }

            hideAllVariantPanels(variantId);
            panel.style.display = 'block';
        }

        function hideAllVariantPanels(variantId) {
            const panels = document.querySelectorAll(`#configPanels_${variantId} .config-panel`);
            panels.forEach(panel => {
                panel.style.display = 'none';
            });
        }

        function createTextPanelForVariant(variantId) {
            const panel = document.createElement('div');
            panel.id = `textPanel_${variantId}`;
            panel.className = 'config-panel';
            panel.style.display = 'none';

            panel.innerHTML = `
        <h4>Add Text</h4>
        <div class="editor-input-group">
            <textarea id="textContent_${variantId}" class="editor-input" placeholder="Enter text content" rows="3"></textarea>
        </div>
        <div id="textCssPanel_${variantId}" class="css-panel" style="display: none;">
            <div class="css-grid">
                <div class="css-group">
                    <label>Font Family:</label>
                    <select id="textFontFamily_${variantId}">
                        <option value="">Default</option>
                        <option value="Arial, sans-serif">Arial</option>
                        <option value="Helvetica, sans-serif">Helvetica</option>
                        <option value="Times New Roman, serif">Times New Roman</option>
                        <option value="Georgia, serif">Georgia</option>
                        <option value="Courier New, monospace">Courier New</option>
                    </select>
                </div>
                <div class="css-group">
                    <label>Font Size:</label>
                    <input type="text" id="textFontSize_${variantId}" placeholder="e.g., 16px, 1.2em">
                </div>
                <div class="css-group">
                    <label>Font Weight:</label>
                    <select id="textFontWeight_${variantId}">
                        <option value="">Normal</option>
                        <option value="bold">Bold</option>
                        <option value="100">100</option>
                        <option value="300">300</option>
                        <option value="400">400</option>
                        <option value="500">500</option>
                        <option value="700">700</option>
                        <option value="900">900</option>
                    </select>
                </div>
                <div class="css-group">
                    <label>Color:</label>
                    <input type="color" id="textColor_${variantId}" value="#000000">
                </div>
                <div class="css-group">
                    <label>Background:</label>
                    <input type="color" id="textBgColor_${variantId}" value="#ffffff">
                </div>
            </div>
        </div>
        <div class="panel-actions">
            <button type="button" class="editor-btn" onclick="addStyledTextForVariant('${variantId}')">Add Text</button>
            <button type="button" class="cancel-btn" onclick="hideAllVariantPanels('${variantId}')">Cancel</button>
        </div>
    `;

            return panel;
        }

        function createListPanelForVariant(variantId) {
            const panel = document.createElement('div');
            panel.id = `listPanel_${variantId}`;
            panel.className = 'config-panel';
            panel.style.display = 'none';

            panel.innerHTML = `
        <h4>Add List</h4>
        <div class="editor-input-group">
            <label>List Type:</label>
            <select id="listType_${variantId}">
                <option value="ul">Unordered List (UL)</option>
                <option value="ol">Ordered List (OL)</option>
            </select>
        </div>
        <div class="editor-input-group">
            <label>List Items (one per line):</label>
            <textarea id="listItems_${variantId}" class="editor-input" placeholder="Enter list items, one per line" rows="5"></textarea>
        </div>
        <div class="panel-actions">
            <button type="button" class="editor-btn" onclick="addListForVariant('${variantId}')">Add List</button>
            <button type="button" class="cancel-btn" onclick="hideAllVariantPanels('${variantId}')">Cancel</button>
        </div>
    `;

            return panel;
        }

        function createHeadingPanelForVariant(variantId) {
            const panel = document.createElement('div');
            panel.id = `headingPanel_${variantId}`;
            panel.className = 'config-panel';
            panel.style.display = 'none';

            panel.innerHTML = `
        <h4>Add Heading</h4>
        <div class="editor-input-group">
            <label>Heading Level:</label>
            <select id="headingLevel_${variantId}">
                <option value="h1">H1</option>
                <option value="h2">H2</option>
                <option value="h3">H3</option>
                <option value="h4">H4</option>
                <option value="h5">H5</option>
                <option value="h6">H6</option>
            </select>
        </div>
        <div class="editor-input-group">
            <label>Heading Text:</label>
            <input type="text" id="headingText_${variantId}" class="editor-input" placeholder="Enter heading text">
        </div>
        <div class="panel-actions">
            <button type="button" class="editor-btn" onclick="addHeadingForVariant('${variantId}')">Add Heading</button>
            <button type="button" class="cancel-btn" onclick="hideAllVariantPanels('${variantId}')">Cancel</button>
        </div>
    `;

            return panel;
        }

        function createLinkPanelForVariant(variantId) {
            const panel = document.createElement('div');
            panel.id = `linkPanel_${variantId}`;
            panel.className = 'config-panel';
            panel.style.display = 'none';

            panel.innerHTML = `
        <h4>Add Link</h4>
        <div class="editor-input-group">
            <label>URL:</label>
            <input type="text" id="linkUrl_${variantId}" class="editor-input" placeholder="https://example.com">
        </div>
        <div class="editor-input-group">
            <label>Link Text:</label>
            <input type="text" id="linkText_${variantId}" class="editor-input" placeholder="Click here">
        </div>
        <div class="editor-input-group">
            <label>Target:</label>
            <select id="linkTarget_${variantId}">
                <option value="_self">Same Tab</option>
                <option value="_blank">New Tab</option>
            </select>
        </div>
        <div class="panel-actions">
            <button type="button" class="editor-btn" onclick="addLinkForVariant('${variantId}')">Add Link</button>
            <button type="button" class="cancel-btn" onclick="hideAllVariantPanels('${variantId}')">Cancel</button>
        </div>
    `;

            return panel;
        }

        // Variant Editor Insert Functions
        function addStyledTextForVariant(variantId) {
            const content = document.getElementById(`textContent_${variantId}`).value;
            if (!content) return;

            const textarea = document.querySelector(`#${variantId} .variant-description-input`);
            const html = `<span>${content}</span>`;
            insertAtCursorForVariant(textarea, html);
            hideAllVariantPanels(variantId);
        }

        function addListForVariant(variantId) {
            const listType = document.getElementById(`listType_${variantId}`).value;
            const items = document.getElementById(`listItems_${variantId}`).value.split('\n').filter(item => item.trim() !== '');

            if (items.length === 0) return;

            const textarea = document.querySelector(`#${variantId} .variant-description-input`);
            let html = `<${listType}>\n`;
            items.forEach(item => {
                html += `  <li>${item}</li>\n`;
            });
            html += `</${listType}>`;

            insertAtCursorForVariant(textarea, html);
            hideAllVariantPanels(variantId);
        }

        function addHeadingForVariant(variantId) {
            const level = document.getElementById(`headingLevel_${variantId}`).value;
            const text = document.getElementById(`headingText_${variantId}`).value;
            if (!text) return;

            const textarea = document.querySelector(`#${variantId} .variant-description-input`);
            const html = `<${level}>${text}</${level}>`;
            insertAtCursorForVariant(textarea, html);
            hideAllVariantPanels(variantId);
        }

        function addLinkForVariant(variantId) {
            const url = document.getElementById(`linkUrl_${variantId}`).value;
            const text = document.getElementById(`linkText_${variantId}`).value || url;
            const target = document.getElementById(`linkTarget_${variantId}`).value;

            if (!url) return;

            const textarea = document.querySelector(`#${variantId} .variant-description-input`);
            const html = `<a href="${url}" target="${target}">${text}</a>`;
            insertAtCursorForVariant(textarea, html);
            hideAllVariantPanels(variantId);
        }

        function addSimpleFormatForVariant(type, variantId) {
            const formats = {
                'bold': ['<strong>', '</strong>'],
                'italic': ['<em>', '</em>']
            };

            const [startTag, endTag] = formats[type];
            const textarea = document.querySelector(`#${variantId} .variant-description-input`);
            insertAtCursorForVariant(textarea, `${startTag}${endTag}`);
        }

        function addLineBreakForVariant(variantId) {
            const textarea = document.querySelector(`#${variantId} .variant-description-input`);
            insertAtCursorForVariant(textarea, '<br>');
        }

        function insertAtCursorForVariant(textarea, text) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const value = textarea.value;

            textarea.value = value.substring(0, start) + text + value.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + text.length;
            textarea.focus();

            // Update preview if enabled
            const preview = textarea.nextElementSibling;
            if (preview && preview.style.display === 'block') {
                preview.innerHTML = textarea.value;
            }
        }

        // Variant Editor Toggle Functions
        function toggleCssPanelForVariant(variantId) {
            const btn = document.getElementById(`cssToggleBtn_${variantId}`);
            const isEnabled = btn.textContent.includes('ON');

            btn.textContent = `CSS: ${isEnabled ? 'OFF' : 'ON'}`;

            // Toggle CSS panels visibility
            const cssPanels = document.querySelectorAll(`#configPanels_${variantId} .css-panel`);
            cssPanels.forEach(panel => {
                panel.style.display = isEnabled ? 'none' : 'block';
            });
        }

        function togglePreviewForVariant(variantId) {
            const btn = document.getElementById(`previewToggleBtn_${variantId}`);
            const textarea = document.querySelector(`#${variantId} .variant-description-input`);
            const preview = textarea.nextElementSibling;

            const isVisible = preview.style.display === 'block';

            if (isVisible) {
                textarea.style.display = 'block';
                preview.style.display = 'none';
                btn.textContent = 'Preview: OFF';
            } else {
                textarea.style.display = 'none';
                preview.style.display = 'block';
                preview.innerHTML = textarea.value;
                btn.textContent = 'Preview: ON';
            }
        }

        // Product Code Duplicate Detection
        function checkProductCodeDuplicate(inputElement, type) {
            const productCode = inputElement.value.trim();
            const warningElement = inputElement.nextElementSibling;

            // Check if warning element exists and is the correct type
            if (!warningElement || !warningElement.classList.contains('duplicate-warning')) {
                console.warn('Duplicate warning element not found for:', inputElement);
                return false;
            }

            if (!productCode) {
                inputElement.style.border = '2px solid var(--border)';
                inputElement.style.backgroundColor = 'var(--white)';
                warningElement.style.display = 'none';
                return false;
            }

            let isDuplicate = false;

            // Check in main products
            for (let itemName in PRODUCTS) {
                const product = PRODUCTS[itemName];

                // Skip the current product being edited
                const editMode = document.getElementById('editMode').value === 'true';
                const originalItemName = document.getElementById('originalItemName').value;

                if (editMode && itemName === originalItemName) {
                    continue; // Skip the product being edited
                }

                // Check main product code
                if (product.productCode === productCode) {
                    isDuplicate = true;
                    break;
                }

                // Check variant codes if product has variants
                if (product.hasVariants && product.variants) {
                    for (let variantName in product.variants) {
                        const variant = product.variants[variantName];
                        if (variant.productCode === productCode) {
                            isDuplicate = true;
                            break;
                        }
                    }
                }

                if (isDuplicate) break;
            }

            // Check other variants in the same form (excluding current variant)
            if (!isDuplicate && type === 'variant') {
                const variantItems = document.querySelectorAll('.variant-item');
                const currentVariantItem = inputElement.closest('.variant-item');

                variantItems.forEach(item => {
                    if (item !== currentVariantItem) {
                        const otherCodeInput = item.querySelector('.variant-code-input');
                        if (otherCodeInput && otherCodeInput.value.trim() === productCode) {
                            isDuplicate = true;
                        }
                    }
                });
            }

            // Apply styling only if elements exist
            if (isDuplicate) {
                inputElement.style.border = '2px solid #ff4444';
                inputElement.style.backgroundColor = '#fff5f5';
                warningElement.style.display = 'block';
            } else {
                inputElement.style.border = '2px solid var(--border)';
                inputElement.style.backgroundColor = 'var(--white)';
                warningElement.style.display = 'none';
            }

            return isDuplicate;
        }
        //NEW : Variant editor functions END

        // // Variant-specific editor functions
        // function showTextPanelForVariant(variantId) {
        //     const textarea = document.querySelector(`#${variantId} .variant-description-input`);
        //     const content = prompt('Enter text content:');
        //     if (content) {
        //         insertAtCursor(textarea, content);
        //     }
        // }

        // function showListPanelForVariant(variantId) {
        //     const textarea = document.querySelector(`#${variantId} .variant-description-input`);
        //     const items = prompt('Enter list items (separated by commas):');
        //     if (items) {
        //         const itemList = items.split(',').map(item => `<li>${item.trim()}</li>`).join('');
        //         insertAtCursor(textarea, `<ul>${itemList}</ul>`);
        //     }
        // }

        // function showHeadingPanelForVariant(variantId) {
        //     const textarea = document.querySelector(`#${variantId} .variant-description-input`);
        //     const level = prompt('Enter heading level (1-6):', '2');
        //     const text = prompt('Enter heading text:');
        //     if (text && level) {
        //         insertAtCursor(textarea, `<h${level}>${text}</h${level}>`);
        //     }
        // }

        // function addSimpleFormatForVariant(type, variantId) {
        //     const formats = {
        //         'bold': ['<strong>', '</strong>'],
        //         'italic': ['<em>', '</em>']
        //     };

        //     const [startTag, endTag] = formats[type];
        //     const textarea = document.querySelector(`#${variantId} .variant-description-input`);
        //     insertAtCursor(textarea, `${startTag}${endTag}`);
        // }

        // function addLineBreakForVariant(variantId) {
        //     const textarea = document.querySelector(`#${variantId} .variant-description-input`);
        //     insertAtCursor(textarea, '<br>');
        // }

        // function showLinkPanelForVariant(variantId) {
        //     const textarea = document.querySelector(`#${variantId} .variant-description-input`);
        //     const url = prompt('Enter URL:');
        //     const text = prompt('Enter link text (optional):') || url;
        //     if (url) {
        //         insertAtCursor(textarea, `<a href="${url}">${text}</a>`);
        //     }
        // }

        // function toggleCssPanelForVariant(variantId) {
        //     alert('CSS styling for variants would be implemented similarly to the main editor');
        // }

        // function togglePreviewForVariant(variantId) {
        //     const textarea = document.querySelector(`#${variantId} .variant-description-input`);
        //     const preview = document.querySelector(`#${variantId} .description-preview`);
        //     const isVisible = preview.style.display === 'block';

        //     if (isVisible) {
        //         textarea.style.display = 'block';
        //         preview.style.display = 'none';
        //     } else {
        //         textarea.style.display = 'none';
        //         preview.style.display = 'block';
        //         preview.innerHTML = textarea.value;
        //     }

        //     const btn = document.getElementById(`previewToggleBtn_${variantId}`);
        //     btn.textContent = `Preview: ${isVisible ? 'OFF' : 'ON'}`;
        // }

        // Batch Add functionality
        function openBatchAdd() {
            document.getElementById('batchModal').style.display = 'flex';
            document.getElementById('batchInput').value = '';
        }

        function closeBatchModal() {
            document.getElementById('batchModal').style.display = 'none';
        }

        function processBatchAdd() {
            const batchInput = document.getElementById('batchInput').value.trim();

            if (!batchInput) {
                showNotification('Please paste some JSON data', 'error');
                return;
            }

            try {
                // Try to parse as JSON object
                let productsData;
                try {
                    productsData = JSON.parse(batchInput);
                } catch (e) {
                    // If direct parse fails, try wrapping in braces
                    try {
                        productsData = JSON.parse(`{${batchInput}}`);
                    } catch (e2) {
                        throw new Error('Invalid JSON format');
                    }
                }

                let addedCount = 0;
                let errorCount = 0;

                // Process each product
                Object.keys(productsData).forEach(itemName => {
                    const productData = productsData[itemName];

                    // Validate required fields based on product type
                    if (productData.hasVariants) {
                        // For variant products, get category from first variant if not in main product
                        const firstVariantKey = Object.keys(productData.variants)[0];
                        const firstVariant = productData.variants[firstVariantKey];
                        const category = productData.category || (firstVariant ? firstVariant.category : null);

                        // Validate variant product - only check these required fields
                        if (!productData.productCode || !category || !productData.variants ||
                            Object.keys(productData.variants).length === 0) {
                            console.error('Missing required fields for variant product:', itemName, {
                                hasProductCode: !!productData.productCode,
                                hasCategory: !!category,
                                hasVariants: !!productData.variants,
                                variantCount: productData.variants ? Object.keys(productData.variants).length : 0
                            });
                            errorCount++;
                            return;
                        }

                        // Also validate that each variant has required fields
                        let validVariants = true;
                        for (let variantName in productData.variants) {
                            const variant = productData.variants[variantName];
                            if (!variant.productCode || !variant.sellPrice) {
                                console.error(`Variant ${variantName} missing required fields:`, {
                                    hasProductCode: !!variant.productCode,
                                    hasSellPrice: !!variant.sellPrice
                                });
                                validVariants = false;
                                break;
                            }
                        }

                        if (!validVariants) {
                            errorCount++;
                            return;
                        }
                    } else {
                        // Validate regular product
                        if (!productData.productCode || !productData.sellPrice || !productData.category) {
                            console.error('Missing required fields for product:', itemName, {
                                hasProductCode: !!productData.productCode,
                                hasSellPrice: !!productData.sellPrice,
                                hasCategory: !!productData.category
                            });
                            errorCount++;
                            return;
                        }
                    }

                    // Prepare complete product data
                    const completeProduct = {
                        itemName: itemName,
                        sectionName: productData.sectionName || '',
                        sectionCode: productData.sectionCode || '',
                        productCode: productData.productCode || '',
                        category: productData.category || 'General'
                    };

                    // For variant products, get category from first variant if not set in main product
                    if (productData.hasVariants && !completeProduct.category) {
                        const firstVariantKey = Object.keys(productData.variants)[0];
                        const firstVariant = productData.variants[firstVariantKey];
                        if (firstVariant && firstVariant.category) {
                            completeProduct.category = firstVariant.category;
                        }
                    }

                    // Add variant-specific fields if it's a variant product
                    if (productData.hasVariants) {
                        completeProduct.hasVariants = true;
                        completeProduct.showVariantName = productData.showVariantName || false;
                        completeProduct.variants = productData.variants;
                    } else {
                        // Add regular product fields
                        completeProduct.image = productData.image || ['default-product.jpg'];
                        completeProduct.sellPrice = productData.sellPrice || '0';
                        completeProduct.mrp = productData.mrp || '0';
                        completeProduct.unit = productData.unit || 'piece';
                        completeProduct.packing = productData.packing || '1pc';
                        completeProduct.brandName = productData.brandName || 'Unknown';
                        completeProduct.inStock = productData.inStock || '0';
                        completeProduct.otherName = productData.otherName || [];
                        completeProduct.description = productData.description || 'No description';
                    }

                    // Save product
                    saveProductDirect(completeProduct);
                    addedCount++;
                });

                closeBatchModal();

                if (addedCount > 0) {
                    showNotification(`Successfully added ${addedCount} products${errorCount > 0 ? `, ${errorCount} failed` : ''}`, 'success');
                    // Reload products to refresh display
                    setTimeout(() => loadProducts(), 500);
                } else {
                    showNotification('No valid products found in the input', 'warning');
                }

            } catch (error) {
                console.error('Batch add error:', error);
                showNotification('Error processing batch data: ' + error.message, 'error');
            }
        }

        async function saveProductDirect(productData) {
            try {
                const db = await getDatabase();

                // Ensure store exists
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    console.log('Store not available, saving to memory only');
                    PRODUCTS[productData.itemName] = productData;
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                await store.put(productData);
                console.log('Product saved:', productData.itemName);

                // Also update the in-memory PRODUCTS object
                PRODUCTS[productData.itemName] = productData;
            } catch (error) {
                console.error('Error saving product:', error);
            }
        }

        // QR Type Selection
        function selectQRType(type) {
            currentQRGridType = type;

            // Update UI
            document.querySelectorAll('.qr-type-option').forEach(option => {
                option.classList.remove('active');
            });
            document.querySelector(`.qr-type-option[data-type="${type}"]`).classList.add('active');

            // Refresh search results and preview
            searchProductsForQRGrid();
            updateQRGridPreview();
        }

        // Updated toggle function to handle selection better
        function toggleQRProductSelection(itemId) {
            // Check if the click was on a quantity control element
            if (event.target.closest('.qr-item-controls')) {
                return; // Don't toggle selection if clicking on quantity controls
            }

            const existingItem = selectedQRProducts.find(item => item.id === itemId);

            if (existingItem) {
                // If already selected, remove it
                selectedQRProducts = selectedQRProducts.filter(item => item.id !== itemId);
            } else {
                // If not selected, add it with default quantity 1
                selectedQRProducts.push({
                    id: itemId,
                    quantity: 1
                });
            }

            console.log('Selection updated:', selectedQRProducts);
            searchProductsForQRGrid(); // Refresh to show selection state
            updateQRGridPreview();
        }

        // Keep the rest of the functions the same
        function updateQRItemQuantity(itemId, newQuantity) {
            const item = selectedQRProducts.find(item => item.id === itemId);
            if (item) {
                item.quantity = parseInt(newQuantity) || 1;
                updateQRGridPreview();
            }
        }

        function removeQRItem(itemId) {
            selectedQRProducts = selectedQRProducts.filter(item => item.id !== itemId);
            searchProductsForQRGrid();
            updateQRGridPreview();
        }

        // Updated search function with event propagation fixes
        function searchProductsForQRGrid() {
            const searchTerm = document.getElementById('qrGridSearch').value.toLowerCase();
            const resultsContainer = document.getElementById('qrGridResults');

            if (!searchTerm) {
                resultsContainer.innerHTML = '<div class="empty-state"><p>Enter a search term to find products</p></div>';
                selectedQRProducts = [];
                updateQRGridPreview();
                return;
            }

            let resultsHTML = '';
            let foundProducts = 0;

            Object.keys(PRODUCTS).forEach(itemName => {
                const product = PRODUCTS[itemName];

                const mainProductMatches = itemName.toLowerCase().includes(searchTerm) ||
                    product.productCode.toLowerCase().includes(searchTerm) ||
                    (product.category && product.category.toLowerCase().includes(searchTerm));

                if (mainProductMatches) {
                    foundProducts++;

                    // Add main product
                    const itemId = `product:${itemName}`;
                    const selectedItem = selectedQRProducts.find(item => item.id === itemId);
                    const isSelected = !!selectedItem;

                    // Show only relevant info based on current QR type
                    let infoLine = '';
                    if (currentQRGridType === 'section') {
                        infoLine = product.sectionCode ? `<div class="qr-grid-item-code">Section: ${product.sectionCode}</div>` : '';
                    } else {
                        infoLine = `<div class="qr-grid-item-code">Product: ${product.productCode}</div>`;
                    }

                    let quantityControls = '';
                    if (isSelected) {
                        quantityControls = `
                    <div class="qr-item-controls" onclick="event.stopPropagation()">
                        <label>Qty:</label>
                        <input type="number" class="quantity-input" value="${selectedItem.quantity}" 
                            min="1" onchange="updateQRItemQuantity('${itemId}', this.value)" onclick="event.stopPropagation()">
                        <button class="remove-item-btn" onclick="event.stopPropagation(); removeQRItem('${itemId}')">Remove</button>
                    </div>
                `;
                    }

                    resultsHTML += `
                <div class="qr-grid-item ${isSelected ? 'selected' : ''}" onclick="toggleQRProductSelection('${itemId}')">
                    <div class="qr-grid-item-name"> ${product.itemName}</div>
                    ${infoLine}
                    <div class="product-category">${product.category}</div>
                    ${quantityControls}
                </div>
            `;

                    // Add variants if product has variants
                    if (product.hasVariants && product.variants) {
                        Object.keys(product.variants).forEach(variantName => {
                            const variant = product.variants[variantName];
                            const variantId = `variant:${itemName}:${variantName}`;
                            const selectedVariant = selectedQRProducts.find(item => item.id === variantId);
                            const isVariantSelected = !!selectedVariant;

                            // Show only relevant info for variants
                            let variantInfoLine = '';
                            if (currentQRGridType === 'section') {
                                variantInfoLine = product.sectionCode ? `<div class="qr-grid-item-code">Section: ${product.sectionCode}</div>` : '';
                            } else {
                                variantInfoLine = `<div class="qr-grid-item-code">Variant: ${variant.productCode}</div>`;
                            }

                            let variantQuantityControls = '';
                            if (isVariantSelected) {
                                variantQuantityControls = `
                            <div class="qr-item-controls" onclick="event.stopPropagation()">
                                <label>Qty:</label>
                                <input type="number" class="quantity-input" value="${selectedVariant.quantity}" 
                                    min="1" onchange="updateQRItemQuantity('${variantId}', this.value)" onclick="event.stopPropagation()">
                                <button class="remove-item-btn" onclick="event.stopPropagation(); removeQRItem('${variantId}')">Remove</button>
                            </div>
                        `;
                            }

                            resultsHTML += `
                        <div class="qr-grid-item ${isVariantSelected ? 'selected' : ''}" onclick="toggleQRProductSelection('${variantId}')">
                            <div class="qr-grid-item-name"> ${product.itemName} - ${variantName}</div>
                            ${variantInfoLine}
                            <div class="product-category">${product.category}  Variant</div>
                            ${variantQuantityControls}
                        </div>
                    `;
                        });
                    }
                }
            });

            if (foundProducts === 0) {
                resultsContainer.innerHTML = '<div class="no-results"><h3>No Products Found</h3><p>Try a different search term</p></div>';
            } else {
                resultsContainer.innerHTML = resultsHTML;
            }
        }

        // Updated preview generation with independent quantities
        function generateA4Preview(selectedItems, qrSize, qrPerRow) {
            const a4GridContainer = document.getElementById('a4GridContainer');
            a4GridContainer.innerHTML = '';

            if (selectedItems.length === 0) {
                a4GridContainer.innerHTML = '<div class="empty-state"><p>Select products to see preview</p></div>';
                updateQRStats(0, 0, 0);
                return;
            }

            // Calculate grid layout
            const availableWidth = 555; // A4 width minus padding
            const availableHeight = 802; // A4 height minus padding
            const itemWidth = availableWidth / qrPerRow;
            const qrPerColumn = Math.floor(availableHeight / (itemWidth + 30)); // Account for labels
            const totalSlots = qrPerRow * qrPerColumn;

            // Expand selected items with their individual quantities
            let itemsToShow = [];
            selectedItems.forEach(item => {
                for (let i = 0; i < item.quantity; i++) {
                    itemsToShow.push(item.id);
                }
            });

            // Calculate how many pages we'll need
            const totalItems = itemsToShow.length;
            const itemsPerPage = qrPerRow * qrPerColumn;
            const totalPages = Math.ceil(totalItems / itemsPerPage);

            // Update stats
            updateQRStats(qrPerRow, qrPerColumn, totalItems);

            // Show current page (first page for preview)
            const currentPageItems = itemsToShow.slice(0, Math.min(itemsPerPage, totalItems));

            // Set grid template
            a4GridContainer.style.gridTemplateColumns = `repeat(${qrPerRow}, 1fr)`;
            a4GridContainer.style.gridTemplateRows = `repeat(${qrPerColumn}, 1fr)`;
            a4GridContainer.style.gap = '10px';

            // Generate QR codes for current page
            currentPageItems.forEach(itemId => {
                const itemData = parseItemId(itemId);
                if (!itemData) {
                    console.warn('Could not parse item:', itemId);
                    return;
                }

                createA4QRCode(itemData, qrSize, a4GridContainer);
            });

            // Show page info if multiple pages
            if (totalPages > 1) {
                const pageInfo = document.createElement('div');
                pageInfo.style.gridColumn = `1 / -1`;
                pageInfo.style.textAlign = 'center';
                pageInfo.style.padding = '10px';
                pageInfo.style.fontSize = '12px';
                pageInfo.style.color = '#666';
                pageInfo.textContent = `Preview: Page 1 of ${totalPages} (Total: ${totalItems} QR codes)`;
                a4GridContainer.appendChild(pageInfo);
            }
        }

        // NEW: PDF Generation using pdfmake.js
        function generateQRPDF() {
            const selectedItems = selectedQRProducts;
            const qrSize = parseInt(document.getElementById('qrSizeSlider').value);
            const qrPerRow = parseInt(document.getElementById('qrPerRowSlider').value);

            if (selectedItems.length === 0) {
                showNotification('No products selected for PDF', 'error');
                return;
            }

            showNotification('Creating PDF with QR codes... This may take a moment.', 'info');

            // Expand selected items with their individual quantities
            let itemsToShow = [];
            selectedItems.forEach(item => {
                for (let i = 0; i < item.quantity; i++) {
                    itemsToShow.push(item.id);
                }
            });

            if (itemsToShow.length === 0) {
                showNotification('No QR codes to generate', 'error');
                return;
            }

            // Generate QR codes and create PDF
            generateQRPDFContent(itemsToShow, qrSize, qrPerRow);
        }

        // NEW: PDF Generation using pdfmake.js
        function generateQRPDF() {
            const selectedItems = selectedQRProducts;
            const qrSize = parseInt(document.getElementById('qrSizeSlider').value);
            const qrPerRow = parseInt(document.getElementById('qrPerRowSlider').value);

            if (selectedItems.length === 0) {
                showNotification('No products selected for PDF', 'error');
                return;
            }

            showNotification('Creating PDF with QR codes... This may take a moment.', 'info');

            // Expand selected items with their individual quantities
            let itemsToShow = [];
            selectedItems.forEach(item => {
                for (let i = 0; i < item.quantity; i++) {
                    itemsToShow.push(item.id);
                }
            });

            if (itemsToShow.length === 0) {
                showNotification('No QR codes to generate', 'error');
                return;
            }

            // Generate QR codes and create PDF
            generateQRPDFContent(itemsToShow, qrSize, qrPerRow);
        }

        async function generateQRPDFContent(itemIds, qrSize, qrPerRow) {
            try {
                const qrItems = [];

                // Generate QR codes for all items
                for (const itemId of itemIds) {
                    const itemData = parseItemId(itemId);
                    if (!itemData) continue;

                    let codeToEncode = '';
                    let displayLabel = '';
                    let codeType = '';

                    // Determine encoding based on QR type
                    switch (currentQRGridType) {
                        case 'section':
                            codeToEncode = itemData.sectionCode || itemData.code;
                            displayLabel = itemData.sectionName || itemData.name;
                            codeType = 'Section';
                            break;
                        case 'variant':
                            codeToEncode = itemData.code;
                            if (itemData.type === 'variant') {
                                displayLabel = `${itemData.name} - ${itemData.variantName}`;
                            } else {
                                displayLabel = itemData.name;
                            }
                            codeType = 'Variant';
                            break;
                        case 'product':
                        default:
                            codeToEncode = itemData.code;
                            displayLabel = itemData.name;
                            codeType = 'Product';
                            break;
                    }

                    if (!codeToEncode) continue;

                    try {
                        // Generate QR code as SVG first
                        const codeWriter = new ZXing.BrowserQRCodeSvgWriter();
                        const svgElement = codeWriter.write(codeToEncode, qrSize, qrSize);
                        const svgString = new XMLSerializer().serializeToString(svgElement);

                        // Convert SVG to PNG data URL for pdfmake compatibility
                        const pngDataUrl = await convertSVGtoPNG(svgString, qrSize);

                        qrItems.push({
                            dataUrl: pngDataUrl,
                            label: displayLabel,
                            code: codeToEncode,
                            type: codeType
                        });
                    } catch (error) {
                        console.error('Error generating QR code:', error);
                        // Add placeholder for failed QR codes
                        qrItems.push({
                            dataUrl: null,
                            label: displayLabel,
                            code: codeToEncode,
                            type: codeType,
                            error: true
                        });
                    }
                }

                if (qrItems.length === 0) {
                    showNotification('No valid QR codes to generate', 'error');
                    return;
                }

                // Create PDF content
                const content = createPDFContent(qrItems, qrSize, qrPerRow);

                const docDefinition = {
                    pageSize: 'A4',
                    pageOrientation: 'portrait',
                    pageMargins: [5, 5, 5, 5],
                    content: content,
                    styles: {
                        qrContainer: {
                            alignment: 'center'
                        },
                        qrLabel: {
                            fontSize: 8,
                            alignment: 'center',
                            margin: [0, 2, 0, 0]
                        },
                        qrCodeText: {
                            fontSize: 6,
                            alignment: 'center',
                            margin: [0, 1, 0, 0],
                            color: '#666666'
                        },
                        errorText: {
                            fontSize: 8,
                            color: '#ff0000',
                            alignment: 'center',
                            italics: true
                        }
                    },
                    // Remove defaultStyle and use implicit fonts
                };

                // Generate and download PDF
                pdfMake.createPdf(docDefinition).download(`QR_Codes_${new Date().getTime()}.pdf`);
                showNotification('PDF with QR codes downloaded successfully!', 'success');

            } catch (error) {
                console.error('PDF generation error:', error);
                showNotification('PDF generation failed: ' + error.message, 'error');
            }
        }

        // NEW: Function to convert SVG to PNG data URL
        function convertSVGtoPNG(svgString, size) {
            return new Promise((resolve, reject) => {
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // Set canvas size
                    canvas.width = size;
                    canvas.height = size;

                    // Create image from SVG
                    const img = new Image();
                    const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
                    const url = URL.createObjectURL(svgBlob);

                    img.onload = function () {
                        // Draw white background
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);

                        // Draw QR code
                        ctx.drawImage(img, 0, 0, size, size);

                        // Convert to PNG data URL
                        const pngDataUrl = canvas.toDataURL('image/png');

                        // Clean up
                        URL.revokeObjectURL(url);

                        resolve(pngDataUrl);
                    };

                    img.onerror = function () {
                        URL.revokeObjectURL(url);
                        reject(new Error('Failed to load SVG image'));
                    };

                    img.src = url;
                } catch (error) {
                    reject(error);
                }
            });
        }

        // Keep the rest of the PDF creation functions the same
        function createPDFContent(qrItems, qrSize, qrPerRow) {
            const tableBody = [];

            // Create table rows
            for (let i = 0; i < qrItems.length; i += qrPerRow) {
                const rowItems = qrItems.slice(i, i + qrPerRow);
                const tableRow = [];

                // Create cells for this row
                rowItems.forEach(item => {
                    const cellContent = [];

                    if (item.error) {
                        cellContent.push({
                            text: 'QR ERROR',
                            style: 'errorText',
                            alignment: 'center'
                        });
                    } else {
                        cellContent.push({
                            image: item.dataUrl,
                            width: qrSize,
                            height: qrSize,
                            alignment: 'center',
                            margin: [0, 5, 0, 0]
                        });
                    }

                    cellContent.push({
                        text: truncateText(item.label, 20),
                        style: 'qrLabel',
                        alignment: 'center',
                        margin: [0, 2, 0, 0]
                    });

                    cellContent.push({
                        text: `${item.type}: ${item.code}`,
                        style: 'qrCodeText',
                        alignment: 'center',
                        margin: [0, 2, 0, 0]
                    });

                    tableRow.push({
                        stack: cellContent,
                        border: [true, true, true, true],
                        margin: [3, 3, 3, 3],
                        alignment: 'center'
                    });
                });

                // Fill empty cells for incomplete rows
                while (tableRow.length < qrPerRow) {
                    tableRow.push({
                        text: '',
                        border: [false, false, false, false]
                    });
                }

                tableBody.push(tableRow);
            }

            return {
                table: {
                    headerRows: 0,
                    widths: Array(qrPerRow).fill('*'), // Equal width columns
                    body: tableBody
                },
                layout: {
                    paddingLeft: function (i) { return 2; },
                    paddingRight: function (i) { return 2; },
                    paddingTop: function (i) { return 2; },
                    paddingBottom: function (i) { return 2; },
                    hLineWidth: function (i, node) { return 0.5; },
                    vLineWidth: function (i, node) { return 0.5; },
                    hLineColor: function (i, node) { return '#cccccc'; },
                    vLineColor: function (i, node) { return '#cccccc'; }
                }
            };
        }

        function createPDFGrid(pageItems, qrSize, qrPerRow) {
            const content = [];
            const rows = [];

            // Group items into rows
            for (let i = 0; i < pageItems.length; i += qrPerRow) {
                const rowItems = pageItems.slice(i, i + qrPerRow);
                const rowColumns = [];

                rowItems.forEach(item => {
                    const columnContent = [];

                    if (item.error) {
                        // Error state
                        columnContent.push({
                            text: 'QR ERROR',
                            style: 'errorText',
                            alignment: 'center'
                        });
                    } else {
                        // Add QR code image
                        columnContent.push({
                            image: item.dataUrl,
                            width: qrSize,
                            height: qrSize,
                            alignment: 'center'
                        });
                    }

                    // Add label
                    columnContent.push({
                        text: truncateText(item.label, 20),
                        style: 'qrLabel',
                        alignment: 'center'
                    });

                    // Add code
                    columnContent.push({
                        text: `${item.type}: ${item.code}`,
                        style: 'qrCodeText',
                        alignment: 'center'
                    });

                    rowColumns.push({
                        stack: columnContent,
                        margin: [1, 1, 1, 1], // Reduced from [5,5,5,10]
                        alignment: 'center'
                    });
                });

                // Fill remaining columns if needed
                while (rowColumns.length < qrPerRow) {
                    rowColumns.push({ text: '' });
                }

                content.push({
                    columns: rowColumns,
                    columnGap: 2, // Reduced from 5
                    margin: [0, 0, 0, 2] // Reduced from [0,0,0,10]
                });
            }

            return content;
        }

        // NEW: Print functionality
        function printQRGrid() {
            const selectedItems = selectedQRProducts;
            const qrSize = parseInt(document.getElementById('qrSizeSlider').value);
            const qrPerRow = parseInt(document.getElementById('qrPerRowSlider').value);

            if (selectedItems.length === 0) {
                showNotification('No products selected for printing', 'error');
                return;
            }

            // Expand selected items with their individual quantities
            let itemsToShow = [];
            selectedItems.forEach(item => {
                for (let i = 0; i < item.quantity; i++) {
                    itemsToShow.push(item.id);
                }
            });

            if (itemsToShow.length === 0) {
                showNotification('No QR codes to print', 'error');
                return;
            }

            // Create print window with ALL QR codes (not just first page)
            const printWindow = window.open('', '_blank');

            // Create container for ALL items
            const allItemsContainer = document.createElement('div');
            allItemsContainer.className = 'a4-grid-container';
            allItemsContainer.style.gridTemplateColumns = `repeat(${qrPerRow}, 1fr)`;
            allItemsContainer.style.gap = '10px';
            allItemsContainer.style.width = '100%';
            allItemsContainer.style.height = 'auto';

            // Generate ALL QR codes for printing
            itemsToShow.forEach(itemId => {
                const itemData = parseItemId(itemId);
                if (itemData) {
                    createA4QRCode(itemData, qrSize, allItemsContainer);
                }
            });

            const printHTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>QR Codes Print</title>
            <style>
                body { 
                    margin: 0; 
                    padding: 10px; 
                    font-family: Arial, sans-serif;
                    -webkit-print-color-adjust: exact;
                    print-color-adjust: exact;
                }
                .a4-grid-container {
                    display: grid;
                    gap: 10px;
                    width: 100%;
                    height: auto;
                }
                .a4-qr-item {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    text-align: center;
                    border: 1px solid #e0e0e0;
                    border-radius: 4px;
                    padding: 8px;
                    background: white;
                    page-break-inside: avoid;
                }
                .a4-qr-label {
                    font-size: 9px;
                    margin-top: 5px;
                    word-break: break-word;
                    max-width: 100%;
                    line-height: 1.2;
                }
                .a4-qr-code-type {
                    font-size: 8px;
                    color: #666;
                    margin-top: 2px;
                }
                @media print {
                    body { margin: 0; padding: 0; }
                    @page { margin: 0; }
                }
            </style>
        </head>
        <body>
            <div class="a4-grid-container" style="grid-template-columns: repeat(${qrPerRow}, 1fr); gap: 10px; width: 100%; height: auto;">
                ${allItemsContainer.innerHTML}
            </div>
            <script>
                window.onload = function() {
                    window.print();
                    setTimeout(() => window.close(), 500);
                }
            <\/script>
        </body>
        </html>
    `;

            printWindow.document.write(printHTML);
            printWindow.document.close();
        }

        // Helper function to truncate text
        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength - 3) + '...';
        }

        function parseItemId(itemId) {
            const parts = itemId.split(':');
            console.log('Parsing item:', itemId, 'Parts:', parts);

            if (parts[0] === 'product') {
                const productName = parts[1];
                const product = PRODUCTS[productName];
                if (!product) {
                    console.warn('Product not found:', productName);
                    return null;
                }

                return {
                    type: 'product',
                    product: product,
                    code: product.productCode,
                    name: product.itemName,
                    sectionCode: product.sectionCode,
                    sectionName: product.sectionName
                };
            }
            else if (parts[0] === 'variant') {
                const productName = parts[1];
                const variantName = parts[2];
                const product = PRODUCTS[productName];

                if (!product || !product.variants || !product.variants[variantName]) {
                    console.warn('Variant not found:', productName, variantName);
                    return null;
                }

                const variant = product.variants[variantName];
                return {
                    type: 'variant',
                    product: product,
                    variant: variant,
                    variantName: variantName,
                    code: variant.productCode,
                    name: product.itemName,
                    sectionCode: product.sectionCode,
                    sectionName: product.sectionName
                };
            }

            console.warn('Unknown item type:', parts[0]);
            return null;
        }

        function updateQRGridPreview() {
            const qrSize = parseInt(document.getElementById('qrSizeSlider').value);
            const qrPerRow = parseInt(document.getElementById('qrPerRowSlider').value);

            // Update displayed values
            document.getElementById('qrSizeValue').textContent = qrSize + 'px';
            document.getElementById('qrPerRowValue').textContent = qrPerRow;

            generateA4Preview(selectedQRProducts, qrSize, qrPerRow);
        }

        function updateQRStats(perRow, perColumn, total) {
            document.getElementById('qrPerRow').textContent = perRow;
            document.getElementById('qrPerColumn').textContent = perColumn;
            document.getElementById('totalQRCodes').textContent = total;
        }

        function createA4QRCode(itemData, qrSize, container) {
            try {
                // Determine what to encode based on selected QR type
                let codeToEncode = '';
                let displayLabel = '';

                switch (currentQRGridType) {
                    case 'section':
                        codeToEncode = itemData.sectionCode || itemData.code;
                        displayLabel = itemData.sectionName || itemData.name;
                        break;
                    case 'variant':
                        codeToEncode = itemData.code;
                        if (itemData.type === 'variant') {
                            displayLabel = `${itemData.name} - ${itemData.variantName}`;
                        } else {
                            displayLabel = itemData.name;
                        }
                        break;
                    case 'product':
                    default:
                        codeToEncode = itemData.code;
                        displayLabel = itemData.name;
                        break;
                }

                if (!codeToEncode) {
                    console.warn('No code to encode for item:', itemData);
                    return;
                }

                console.log('Creating QR for:', displayLabel, 'Code:', codeToEncode);

                const codeWriter = new ZXing.BrowserQRCodeSvgWriter();
                const svgElement = codeWriter.write(codeToEncode, qrSize, qrSize);

                const qrItem = document.createElement('div');
                qrItem.className = 'a4-qr-item';
                qrItem.style.display = 'flex';
                qrItem.style.flexDirection = 'column';
                qrItem.style.alignItems = 'center';
                qrItem.style.justifyContent = 'center';
                qrItem.style.padding = '8px';
                qrItem.style.border = '1px solid #e0e0e0';
                qrItem.style.borderRadius = '4px';
                qrItem.style.background = 'white';

                // Add SVG QR Code
                qrItem.appendChild(svgElement);

                // Create labels container
                const labelsContainer = document.createElement('div');
                labelsContainer.style.marginTop = '5px';
                labelsContainer.style.width = '100%';
                labelsContainer.style.textAlign = 'center';

                // Main Label (Product/Variant Name)
                const nameLabel = document.createElement('div');
                nameLabel.className = 'a4-qr-label';
                nameLabel.textContent = displayLabel.length > 30 ? displayLabel.substring(0, 27) + '...' : displayLabel;
                nameLabel.style.fontSize = '9px';
                nameLabel.style.lineHeight = '1.2';
                nameLabel.style.wordBreak = 'break-word';
                labelsContainer.appendChild(nameLabel);

                // Code Type Label
                const codeTypeLabel = document.createElement('div');
                codeTypeLabel.className = 'a4-qr-code-type';
                codeTypeLabel.style.fontSize = '8px';
                codeTypeLabel.style.color = '#666';
                codeTypeLabel.style.marginTop = '2px';

                if (currentQRGridType === 'section') {
                    codeTypeLabel.textContent = `Section: ${codeToEncode}`;
                } else if (currentQRGridType === 'variant') {
                    codeTypeLabel.textContent = `Variant: ${codeToEncode}`;
                } else {
                    codeTypeLabel.textContent = `Product: ${codeToEncode}`;
                }

                labelsContainer.appendChild(codeTypeLabel);
                qrItem.appendChild(labelsContainer);
                container.appendChild(qrItem);

            } catch (error) {
                console.error('Error creating QR code:', error);
                // Create a placeholder if QR generation fails
                const placeholder = document.createElement('div');
                placeholder.className = 'a4-qr-item';
                placeholder.style.display = 'flex';
                placeholder.style.flexDirection = 'column';
                placeholder.style.alignItems = 'center';
                placeholder.style.justifyContent = 'center';
                placeholder.style.padding = '8px';
                placeholder.style.border = '1px dashed #ccc';
                placeholder.style.background = '#f9f9f9';
                placeholder.innerHTML = `
            <div style="width: ${qrSize}px; height: ${qrSize}px; background: #eee; display: flex; align-items: center; justify-content: center;">
                <span style="color: #999; font-size: 12px;">QR Error</span>
            </div>
            <div style="font-size: 9px; margin-top: 5px; text-align: center;">Failed to generate QR</div>
        `;
                container.appendChild(placeholder);
            }
        }

        // Search and Filter functionality
        function setupSearchAndFilter() {
            const searchInput = document.getElementById('searchInput');
            const categoryFilter = document.getElementById('categoryFilter');

            searchInput.addEventListener('input', filterProducts);
            categoryFilter.addEventListener('change', filterProducts);
        }

        function filterProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const selectedCategory = document.getElementById('categoryFilter').value.toLowerCase();

            if (currentSortField === 'none') {
                let filteredProducts = {};

                Object.keys(PRODUCTS).forEach(itemName => {
                    const product = PRODUCTS[itemName];
                    if (!product) return; // Skip if product is undefined

                    // Safe property access with fallbacks
                    const productCode = product.productCode || '';
                    const brandName = product.brandName || '';
                    const description = product.description || '';
                    const otherNames = product.otherName || [];
                    const category = product.category || '';

                    const matchesSearch = searchTerm === '' ||
                        itemName.toLowerCase().includes(searchTerm) ||
                        productCode.toLowerCase().includes(searchTerm) ||
                        brandName.toLowerCase().includes(searchTerm) ||
                        (otherNames.some(name => name && name.toLowerCase().includes(searchTerm))) ||
                        description.toLowerCase().includes(searchTerm);

                    // Case-insensitive category matching
                    const productCategory = category.toLowerCase();
                    const matchesCategory = selectedCategory === 'all' || productCategory === selectedCategory;

                    if (matchesSearch && matchesCategory) {
                        filteredProducts[itemName] = product;
                    }
                });

                displayProducts(filteredProducts);
            } else {
                // If sorting is active, re-apply sorting
                sortProducts();
            }
        }

        function updateCategoryFilter() {
            const categoryFilter = document.getElementById('categoryFilter');
            const currentValue = categoryFilter.value;

            categoryFilter.innerHTML = '<option value="all">All Categories</option>';

            // Use Map to store original case but compare lowercase
            const categoryMap = new Map();
            Array.from(allCategories).forEach(category => {
                const lowerCaseCategory = category.toLowerCase();
                if (!categoryMap.has(lowerCaseCategory)) {
                    categoryMap.set(lowerCaseCategory, category); // Store original case
                }
            });

            // Convert to array and sort by lowercase
            Array.from(categoryMap.entries())
                .sort((a, b) => a[0].localeCompare(b[0])) // Sort by lowercase key
                .forEach(([lowerCaseKey, originalCategory]) => {
                    const option = document.createElement('option');
                    option.value = lowerCaseKey; // Use lowercase as value for filtering
                    option.textContent = originalCategory; // Show original case in display
                    categoryFilter.appendChild(option);
                });

            // Restore previous selection if it still exists
            const currentLower = currentValue.toLowerCase();
            if (categoryMap.has(currentLower)) {
                categoryFilter.value = currentLower;
            }
        }

        function updateCategories() {
            allCategories.clear();
            Object.keys(PRODUCTS).forEach(itemName => {
                allCategories.add(PRODUCTS[itemName].category);
            });
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = 'all';
            document.getElementById('sortBy').value = 'none';
            document.getElementById('sortOrderBtn').style.display = 'none';

            currentSortField = 'none';
            currentSortOrder = 'asc';

            filterProducts();
            showNotification('Filters and sorting cleared', 'info');
        }

        // Sorting Functions
        function applySorting() {
            const sortSelect = document.getElementById('sortBy');
            currentSortField = sortSelect.value;

            const sortOrderBtn = document.getElementById('sortOrderBtn');

            if (currentSortField === 'none') {
                sortOrderBtn.style.display = 'none';
                displayProducts(); // Reset to original order
            } else {
                sortOrderBtn.style.display = 'block';
                sortProducts();
            }
        }

        function toggleSortOrder() {
            currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            const sortOrderBtn = document.getElementById('sortOrderBtn');
            sortOrderBtn.textContent = currentSortOrder === 'asc' ? ' Ascending' : ' Descending';

            if (currentSortField !== 'none') {
                sortProducts();
            }
        }

        function sortProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;

            let productsToSort = {};

            // First apply search and category filters
            Object.keys(PRODUCTS).forEach(itemName => {
                const product = PRODUCTS[itemName];
                const matchesSearch = searchTerm === '' ||
                    itemName.toLowerCase().includes(searchTerm) ||
                    product.productCode.toLowerCase().includes(searchTerm) ||
                    product.brandName.toLowerCase().includes(searchTerm) ||
                    (product.otherName && product.otherName.some(name => name.toLowerCase().includes(searchTerm))) ||
                    product.description.toLowerCase().includes(searchTerm);

                const matchesCategory = category === 'all' || product.category === category;

                if (matchesSearch && matchesCategory) {
                    productsToSort[itemName] = product;
                }
            });

            // Convert to array for sorting
            let productsArray = Object.entries(productsToSort);

            if (currentSortField !== 'none') {
                productsArray.sort((a, b) => {
                    const productA = a[1];
                    const productB = b[1];
                    let valueA, valueB;

                    switch (currentSortField) {
                        case 'name':
                            valueA = productA.itemName.toLowerCase();
                            valueB = productB.itemName.toLowerCase();
                            break;
                        case 'productCode':
                            valueA = productA.productCode.toLowerCase();
                            valueB = productB.productCode.toLowerCase();
                            break;
                        case 'itemName':
                            valueA = productA.itemName.toLowerCase();
                            valueB = productB.itemName.toLowerCase();
                            break;
                        case 'sectionCode':
                            valueA = (productA.sectionCode || '').toLowerCase();
                            valueB = (productB.sectionCode || '').toLowerCase();
                            break;
                        case 'sectionName':
                            valueA = (productA.sectionName || '').toLowerCase();
                            valueB = (productB.sectionName || '').toLowerCase();
                            break;
                        case 'cardType':
                            valueA = productA.hasVariants ? 'variant' : 'regular';
                            valueB = productB.hasVariants ? 'variant' : 'regular';
                            break;
                        default:
                            return 0;
                    }

                    // Handle empty values
                    if (!valueA) valueA = '';
                    if (!valueB) valueB = '';

                    let result = 0;
                    if (valueA < valueB) result = -1;
                    if (valueA > valueB) result = 1;

                    // Apply sort order
                    return currentSortOrder === 'asc' ? result : -result;
                });
            }

            // Convert back to object while preserving order
            const sortedProducts = {};
            productsArray.forEach(([key, value]) => {
                sortedProducts[key] = value;
            });

            displayProducts(sortedProducts);
            updateJSONOutput(); // Update JSON with sorted data
        }

        // Form handling
        function setupForm() {
            const form = document.getElementById('productForm');
            form.addEventListener('submit', handleFormSubmit);
        }

        function handleFormSubmit(event) {
            event.preventDefault();

            const formData = getFormData();
            const isEdit = document.getElementById('editMode').value === 'true';

            if (validateForm(formData, isEdit)) {
                saveProduct(formData);
            }
        }

        function getFormData() {
            const hasVariants = document.getElementById('hasVariants').checked;

            const formData = {
                itemName: document.getElementById('itemName').value.trim(),
                sectionName: document.getElementById('sectionName').value.trim(),
                sectionCode: document.getElementById('sectionCode').value.trim(),
                productCode: document.getElementById('productCode').value.trim(),
                category: document.getElementById('category').value.trim()
            };

            // Add image URLs field
            const imageUrls = document.getElementById('imageUrls').value
                .split(',')
                .map(url => url.trim())
                .filter(url => url !== '') || ['default-product.jpg'];

            // Add regular fields only if not a variant product
            if (!hasVariants) {
                const otherNames = document.getElementById('otherNames').value
                    .split(',')
                    .map(name => name.trim())
                    .filter(name => name !== '');

                Object.assign(formData, {
                    image: imageUrls.length > 0 ? imageUrls : ['default-product.jpg'],
                    sellPrice: document.getElementById('sellPrice').value,
                    mrp: document.getElementById('mrp').value || '0',
                    unit: document.getElementById('unit').value.trim(),
                    packing: document.getElementById('packing').value.trim(),
                    brandName: document.getElementById('brandName').value.trim(),
                    inStock: document.getElementById('inStock').value,
                    otherName: otherNames,
                    description: document.getElementById('description').value.trim()
                });
            }

            // Add variant-specific fields if it's a variant product
            if (hasVariants) {
                formData.hasVariants = true;
                formData.showVariantName = document.getElementById('showVariantName').checked;
                formData.variants = getVariantsData();
            }

            return formData;
        }

        function validateForm(formData, isEdit = false) {
            const requiredFields = [
                'itemName', 'productCode', 'category'
            ];

            // Check for duplicate product codes in main product
            if (!isEdit || (isEdit && formData.productCode !== PRODUCTS[document.getElementById('originalItemName').value].productCode)) {
                if (checkProductCodeDuplicate(document.getElementById('productCode'), 'product')) {
                    showNotification('Product code already exists! Please use a unique code.', 'error');
                    return false;
                }
            }

            // Check variant codes for duplicates
            if (formData.hasVariants) {
                const variantItems = document.querySelectorAll('.variant-item');
                for (let item of variantItems) {
                    const codeInput = item.querySelector('.variant-code-input');
                    if (checkProductCodeDuplicate(codeInput, 'variant')) {
                        showNotification(`Variant code "${codeInput.value}" already exists!`, 'error');
                        return false;
                    }
                }
            }

            for (let field of requiredFields) {
                if (!formData[field]) {
                    showNotification(`Please fill in the ${field.replace(/([A-Z])/g, ' $1').toLowerCase()}`, 'error');
                    return false;
                }
            }

            // Check for duplicate product name (only when adding new product)
            if (!isEdit && PRODUCTS[formData.itemName]) {
                showNotification('Product with this name already exists!', 'error');
                return false;
            }

            // Validate variants if product has variants
            if (formData.hasVariants) {
                const variants = formData.variants;
                if (Object.keys(variants).length === 0) {
                    showNotification('Please add at least one variant', 'error');
                    return false;
                }

                for (let variantName in variants) {
                    const variant = variants[variantName];
                    if (!variant.productCode || !variant.sellPrice || !variant.brandName || !variant.category) {
                        showNotification(`Variant "${variantName}" is missing required fields`, 'error');
                        return false;
                    }
                }
            } else {
                // Validate regular product fields
                if (!formData.sellPrice || formData.sellPrice <= 0) {
                    showNotification('Sell Price must be greater than 0', 'error');
                    return false;
                }

                if (formData.inStock < 0) {
                    showNotification('In Stock quantity cannot be negative', 'error');
                    return false;
                }
            }

            return true;
        }

        function clearForm() {
            document.getElementById('productForm').reset();
            document.getElementById('editMode').value = 'false';
            document.getElementById('originalItemName').value = '';
            document.getElementById('formTitle').textContent = 'Add New Product';
            document.getElementById('submitBtn').textContent = 'Add Product';
            document.getElementById('cancelBtn').style.display = 'none';
            document.querySelector('#addItem').classList.remove('edit-mode');
            document.getElementById('hasVariants').checked = false;
            document.getElementById('variantsContainer').classList.remove('show');
            document.getElementById('variantsList').innerHTML = '';

            // Show all regular fields and restore required attributes
            document.querySelectorAll('.regular-field').forEach(field => {
                field.style.display = 'flex';
                const inputs = field.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    if (input.getAttribute('data-was-required') === 'true') {
                        input.setAttribute('required', 'true');
                    }
                });
            });

            // Remove all data-was-required attributes
            document.querySelectorAll('[data-was-required]').forEach(element => {
                element.removeAttribute('data-was-required');
            });
        }

        function editProduct(itemName) {
            const product = PRODUCTS[itemName];
            if (!product) return;

            currentEditProduct = itemName;

            // Populate form with product data
            document.getElementById('itemName').value = product.itemName;
            document.getElementById('productCode').value = product.productCode;
            document.getElementById('sectionName').value = product.sectionName || '';
            document.getElementById('sectionCode').value = product.sectionCode || '';
            document.getElementById('category').value = product.category;

            // Populate image URLs
            if (document.getElementById('imageUrls')) {
                document.getElementById('imageUrls').value = Array.isArray(product.image) ? product.image.join(', ') : product.image;
            }

            // Handle variants
            if (product.hasVariants) {
                document.getElementById('hasVariants').checked = true;
                document.getElementById('showVariantName').checked = product.showVariantName || false;
                toggleVariants();

                // Populate variants
                const variantsList = document.getElementById('variantsList');
                variantsList.innerHTML = '';

                let variantIndex = 0;
                for (let variantName in product.variants) {
                    const variant = product.variants[variantName];
                    const variantId = 'variant_' + Date.now() + '_' + variantIndex;
                    variantIndex++;

                    const variantHTML = `
    <div class="variant-item" id="${variantId}">
        <div class="variant-header">
            <div class="variant-name">Variant ${variantIndex}</div>
            <button type="button" class="remove-variant-btn" onclick="removeVariant('${variantId}')">Remove</button>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Variant Name</label>
                <input type="text" class="variant-name-input" value="${variantName}" required>
            </div>
            <div class="form-group">
                <label>Product Code</label>
                <input type="text" class="variant-code-input" value="${variant.productCode}" required oninput="checkProductCodeDuplicate(this, 'variant')">
                <div class="duplicate-warning" style="display: none; color: red; font-size: 12px; margin-top: 4px;">Product code already exists</div>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Brand Name</label>
                <input type="text" class="variant-brand-input" value="${variant.brandName || ''}" required>
            </div>
            <div class="form-group">
                <label>Category</label>
                <input type="text" class="variant-category-input" value="${variant.category || ''}" required>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Sell Price</label>
                <input type="number" class="variant-sellprice-input" value="${variant.sellPrice}" step="0.01" required>
            </div>
            <div class="form-group">
                <label>MRP</label>
                <input type="number" class="variant-mrp-input" value="${variant.mrp}" step="0.01">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Unit</label>
                <input type="text" class="variant-unit-input" value="${variant.unit}" required>
            </div>
            <div class="form-group">
                <label>Packing</label>
                <input type="text" class="variant-packing-input" value="${variant.packing}" required>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>In Stock</label>
                <input type="number" class="variant-stock-input" value="${variant.inStock}" required>
            </div>
            <div class="form-group">
                <label>Image URLs (comma separated)</label>
                <input type="text" class="variant-image-input" value="${Array.isArray(variant.image) ? variant.image.join(', ') : variant.image}">
            </div>
        </div>
        <div class="form-group">
            <label>Other Names (comma separated)</label>
            <input type="text" class="variant-othernames-input" value="${variant.otherName ? variant.otherName.join(', ') : ''}">
        </div>
        <div class="form-group">
            <label>Description</label>
            <textarea class="variant-description-input" rows="3" required style="width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: var(--radius);">${variant.description}</textarea>
        </div>
    </div>
`;

                    variantsList.insertAdjacentHTML('beforeend', variantHTML);
                }
            } else {
                // Populate regular product fields
                document.getElementById('sellPrice').value = product.sellPrice;
                document.getElementById('mrp').value = product.mrp;
                document.getElementById('unit').value = product.unit;
                document.getElementById('packing').value = product.packing;
                document.getElementById('brandName').value = product.brandName;
                document.getElementById('inStock').value = product.inStock;
                document.getElementById('otherNames').value = Array.isArray(product.otherName) ? product.otherName.join(', ') : product.otherName;
                document.getElementById('description').value = product.description;
            }

            // Set edit mode
            document.getElementById('editMode').value = 'true';
            document.getElementById('originalItemName').value = itemName;
            document.getElementById('formTitle').textContent = 'Edit Product';
            document.getElementById('submitBtn').textContent = 'Update Product';
            document.getElementById('cancelBtn').style.display = 'block';
            document.querySelector('#addItem').classList.add('edit-mode');

            // Switch to Add Item section
            showSection('addItem');

            showNotification('Product loaded for editing', 'info');
        }

        function cancelEdit() {
            clearForm();
            showNotification('Edit cancelled', 'info');
        }

        // Display functions - Updated with variant buttons and dual QR codes
        function displayProducts(productsToDisplay = null) {
            const grid = document.getElementById('productsGrid');
            const products = productsToDisplay || PRODUCTS;

            if (Object.keys(products).length === 0) {
                let message = '';
                if (Object.keys(PRODUCTS).length === 0) {
                    message = `
                <div class="empty-state">
                    <h3>No Products Added</h3>
                    <p>Add your first product using the "Add Item" section</p>
                </div>
            `;
                } else {
                    message = `
                <div class="no-results">
                    <h3>No Products Found</h3>
                    <p>No products match your current search criteria</p>
                    <button class="clear-filters-btn" onclick="clearFilters()" style="margin-top: 15px;">
                        Clear Filters
                    </button>
                </div>
            `;
                }
                grid.innerHTML = message;
                return;
            }

            const productsHTML = Object.keys(products).map(itemName => {
                const product = products[itemName];

                // Check if this is a valid product with proper structure
                if (!product || typeof product !== 'object') {
                    console.error('Invalid product data:', itemName, product);
                    return '';
                }

                let productInfo = '';

                if (product.hasVariants && product.variants) {
                    // Display variant product with variant buttons
                    const variantCount = Object.keys(product.variants).length;
                    const variantButtons = Object.keys(product.variants).map(variantName => {
                        const variant = product.variants[variantName];
                        const displayName = product.showVariantName ? `${itemName} ${variantName}` : variantName;
                        return `<button class="variant-btn" onclick="selectVariant('${itemName}', '${variantName}', this)" 
                        style="cursor: pointer;">
                        ${displayName}
                        </button>`;
                    }).join('');

                    productInfo = `
                <div class="product-card">
                    <div class="product-header">
                        <div>
                            <div class="product-name">${product.itemName}</div>
                            <div class="product-code">Main Code: ${product.productCode || 'N/A'}</div>
                            <div class="product-category">${product.category || 'Uncategorized'}  ${variantCount} variants</div>
                        </div>
                        <div class="product-price">Multiple Prices</div>
                    </div>
                    
                    <div class="product-details">
                        <div class="product-detail">
                            <strong>Section:</strong> ${product.sectionName || 'N/A'}
                        </div>
                        <div class="product-detail">
                            <strong>Section Code:</strong> ${product.sectionCode || 'N/A'}
                        </div>
                        <div class="product-detail">
                            <strong>Brand:</strong> ${getFirstVariantBrand(product) || 'N/A'}
                        </div>
                        <div class="product-detail">
                            <strong>Show Variant Names:</strong> ${product.showVariantName ? 'Yes' : 'No'}
                        </div>
                    </div>
                    
                    <!-- Variant Buttons -->
                    <div style="margin: 10px 0;">
                        <div style="font-size: 12px; font-weight: 600; margin-bottom: 5px; color: var(--primary);">Variants:</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                            ${variantButtons}
                        </div>
                    </div>
                    
                    <!-- Variant Details Container -->
                    <div id="variant-details-${itemName.replace(/\s+/g, '-')}" class="variant-details-container" style="display: none; margin-top: 15px; padding: 15px; background: white; border-radius: var(--radius); border: 1px solid var(--border);">
                        <!-- Variant details will be displayed here -->
                    </div>
                    
                    <div class="product-actions">
                        <button class="edit-btn" onclick="editProduct('${itemName}')">Edit</button>
                        <button class="qr-btn" onclick="generateSectionQRCode('${product.sectionCode}')">
                            <span style="font-size: 12px;"></span> Section QR
                        </button>
                        <button class="qr-btn" onclick="generateProductQRCode(${escapeProductData(product)})">
                            <span style="font-size: 12px;"></span> Product QR
                        </button>
                        <button class="remove-btn" onclick="deleteProduct('${itemName}')">Remove</button>
                    </div>
                </div>
            `;
                } else {
                    // Display regular product
                    productInfo = `
                <div class="product-card">
                    <div class="product-header">
                        <div>
                            <div class="product-name">${product.itemName}</div>
                            <div class="product-code">Code: ${product.productCode}</div>
                            <div class="product-category">${product.category}</div>
                        </div>
                        <div class="product-price">${product.sellPrice}</div>
                    </div>
                    
                    <div class="product-details">
                        <div class="product-detail">
                            <strong>Section:</strong> ${product.sectionName || 'N/A'}
                        </div>
                        <div class="product-detail">
                            <strong>Section Code:</strong> ${product.sectionCode || 'N/A'}
                        </div>
                        <div class="product-detail">
                            <strong>Brand:</strong> ${product.brandName}
                        </div>
                        <div class="product-detail">
                            <strong>Unit:</strong> ${product.unit}
                        </div>
                        <div class="product-detail">
                            <strong>Packing:</strong> ${product.packing}
                        </div>
                        <div class="product-detail">
                            <strong>In Stock:</strong> ${product.inStock}
                        </div>
                        ${product.mrp > 0 ? `
                        <div class="product-detail">
                            <strong>MRP:</strong> ${product.mrp}
                        </div>
                        ` : ''}
                        <div class="product-detail">
                            <strong>Description:</strong> ${product.description}
                        </div>
                        ${product.otherName && product.otherName.length > 0 ? `
                        <div class="product-detail">
                            <strong>Other Names:</strong> ${product.otherName.join(', ')}
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="product-actions">
                        <button class="edit-btn" onclick="editProduct('${itemName}')">Edit</button>
                        <button class="qr-btn" onclick="generateSectionQRCode('${product.sectionCode}')">
                            <span style="font-size: 12px;"></span> Section QR
                        </button>
                        <button class="qr-btn" onclick="generateProductQRCode(${escapeProductData(product)})">
                            <span style="font-size: 12px;"></span> Product QR
                        </button>
                        <button class="remove-btn" onclick="deleteProduct('${itemName}')">Remove</button>
                    </div>
                </div>
            `;
                }

                return productInfo;
            }).join('');

            grid.innerHTML = productsHTML;
        }

        function getFirstVariantBrand(product) {
            if (product.variants && Object.keys(product.variants).length > 0) {
                const firstVariant = product.variants[Object.keys(product.variants)[0]];
                return firstVariant.brandName || 'N/A';
            }
            return 'N/A';
        }

        // Variant selection function
        function selectVariant(productName, variantName, buttonElement) {
            const product = PRODUCTS[productName];
            if (!product || !product.variants || !product.variants[variantName]) {
                showNotification('Variant data not found', 'error');
                return;
            }

            const variant = product.variants[variantName];
            const containerId = `variant-details-${productName.replace(/\s+/g, '-')}`;
            let detailsContainer = document.getElementById(containerId);

            // Check if this variant is already active
            const isAlreadyActive = buttonElement.classList.contains('active');

            // Remove active class from all variant buttons in this product card
            const productCard = buttonElement.closest('.product-card');
            const variantButtons = productCard.querySelectorAll('.variant-btn');
            variantButtons.forEach(btn => btn.classList.remove('active'));

            // If this variant was already active, hide the details and return
            if (isAlreadyActive && detailsContainer) {
                detailsContainer.style.display = 'none';
                return;
            }

            // Add active class to clicked button
            buttonElement.classList.add('active');

            // Create variant details HTML
            const variantDetailsHTML = `
        <div style="border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 10px;">
            <h4 style="color: var(--primary); margin-bottom: 8px;">${productName} - ${variantName}</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
                <div><strong>Variant Code:</strong> ${variant.productCode}</div>
                <div><strong>Sell Price:</strong> ${variant.sellPrice}</div>
                <div><strong>Unit:</strong> ${variant.unit}</div>
                <div><strong>Packing:</strong> ${variant.packing}</div>
                <div><strong>In Stock:</strong> ${variant.inStock}</div>
                <div><strong>Brand:</strong> ${variant.brandName}</div>
                ${variant.mrp > 0 ? `<div><strong>MRP:</strong> ${variant.mrp}</div>` : ''}
            </div>
        </div>
        <div style="font-size: 13px;">
            <div><strong>Description:</strong> ${variant.description}</div>
            <div style="margin-top: 8px;">
                <strong>QR Codes:</strong>
                <div style="display: flex; gap: 10px; margin-top: 5px;">
                    <button class="qr-btn" onclick="generateSectionQRCode('${product.sectionCode}')" style="padding: 4px 8px; font-size: 11px;">
                        <span style="font-size: 10px;"></span> Section: ${product.sectionCode || 'N/A'}
                    </button>
                    <button class="qr-btn" onclick="generateVariantQRCode(${escapeProductData(variant)})" style="padding: 4px 8px; font-size: 11px;">
                        <span style="font-size: 10px;"></span> Variant: ${variant.productCode}
                    </button>
                </div>
            </div>
        </div>
    `;

            // Get or create variant details container
            if (!detailsContainer) {
                // If container doesn't exist, create it
                detailsContainer = document.createElement('div');
                detailsContainer.id = containerId;
                detailsContainer.className = 'variant-details-container';
                detailsContainer.style.cssText = 'margin-top: 15px; padding: 15px; background: white; border-radius: var(--radius); border: 1px solid var(--border);';
                buttonElement.closest('.product-card').querySelector('.product-actions').before(detailsContainer);
            }

            // Update container content and show it
            detailsContainer.innerHTML = variantDetailsHTML;
            detailsContainer.style.display = 'block';
        }

        // Dual QR Code functions
        function generateSectionQRCode(sectionCode) {
            if (!sectionCode) {
                showNotification('No section code available', 'error');
                return;
            }

            currentQRProduct = { sectionCode: sectionCode };
            currentQRType = 'section';

            try {
                const codeWriter = new ZXing.BrowserQRCodeSvgWriter();
                const svgElement = codeWriter.write(sectionCode, 300, 300);

                const qrContainer = document.getElementById('qrCodeCanvas');
                qrContainer.innerHTML = '';
                qrContainer.appendChild(svgElement);

                // Update modal title and info
                document.getElementById('qrModalTitle').textContent = ' Section QR Code';
                document.getElementById('qrCodeInfo').textContent = `Scan this QR code for section: ${sectionCode}`;

                openQRModal();
            } catch (error) {
                console.error('QR Code generation error:', error);
                showNotification('Error generating QR code', 'error');
            }
        }

        function generateProductQRCode(product) {
            const codeToEncode = product.hasVariants ? product.productCode : product.productCode;
            currentQRProduct = product;
            currentQRType = 'product';

            try {
                const codeWriter = new ZXing.BrowserQRCodeSvgWriter();
                const svgElement = codeWriter.write(codeToEncode, 300, 300);

                const qrContainer = document.getElementById('qrCodeCanvas');
                qrContainer.innerHTML = '';
                qrContainer.appendChild(svgElement);

                // Update modal title and info
                const title = product.hasVariants ? ' Main Product QR Code' : ' Product QR Code';
                const info = product.hasVariants ?
                    `Scan this QR code for main product: ${product.productCode}` :
                    `Scan this QR code for product: ${product.productCode}`;

                document.getElementById('qrModalTitle').textContent = title;
                document.getElementById('qrCodeInfo').textContent = info;

                openQRModal();
            } catch (error) {
                console.error('QR Code generation error:', error);
                showNotification('Error generating QR code', 'error');
            }
        }

        function generateVariantQRCode(variant) {
            currentQRProduct = variant;
            currentQRType = 'variant';

            try {
                const codeWriter = new ZXing.BrowserQRCodeSvgWriter();
                const svgElement = codeWriter.write(variant.productCode, 300, 300);

                const qrContainer = document.getElementById('qrCodeCanvas');
                qrContainer.innerHTML = '';
                qrContainer.appendChild(svgElement);

                // Update modal title and info
                document.getElementById('qrModalTitle').textContent = ' Variant QR Code';
                document.getElementById('qrCodeInfo').textContent = `Scan this QR code for variant: ${variant.productCode}`;

                openQRModal();
            } catch (error) {
                console.error('QR Code generation error:', error);
                showNotification('Error generating QR code', 'error');
            }
        }

        function openQRModal() {
            document.getElementById('qrModal').style.display = 'flex';
        }

        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
            currentQRProduct = null;
            currentQRType = null;
        }

        function downloadQRCode() {
            if (!currentQRProduct) return;

            try {
                const svgElement = document.querySelector('#qrCodeCanvas svg');
                if (!svgElement) {
                    throw new Error('QR code not found');
                }

                // Convert SVG to data URL
                const svgData = new XMLSerializer().serializeToString(svgElement);
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();

                // Set canvas size - increased height to accommodate text
                canvas.width = 350;
                canvas.height = 370; // Slightly increased height for text

                img.onload = function () {
                    // Draw white background
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    // Draw QR code (moved up to make space for text)
                    ctx.drawImage(img, 25, 25, 300, 300);

                    // Add text below QR code
                    ctx.fillStyle = 'black';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';

                    let codeText = '';
                    if (currentQRType === 'section') {
                        codeText = `Section Code: ${currentQRProduct.sectionCode}`;
                    } else if (currentQRType === 'variant') {
                        codeText = `Product Code: ${currentQRProduct.productCode}`;
                    } else {
                        codeText = `Product Code: ${currentQRProduct.productCode}`;
                    }

                    // Draw the code text
                    ctx.fillText(codeText, canvas.width / 2, 345);

                    // Convert to PNG and download
                    const pngFile = canvas.toDataURL('image/png');
                    const downloadLink = document.createElement('a');

                    // Set filename based on QR type
                    let filename = '';
                    if (currentQRType === 'section') {
                        filename = `section_${currentQRProduct.sectionCode}_qrcode.png`;
                    } else if (currentQRType === 'variant') {
                        filename = `variant_${currentQRProduct.productCode}_qrcode.png`;
                    } else {
                        filename = `${currentQRProduct.productCode}_qrcode.png`;
                    }

                    downloadLink.download = filename;
                    downloadLink.href = pngFile;
                    downloadLink.click();

                    showNotification('QR code downloaded successfully!', 'success');
                };

                img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));

            } catch (error) {
                console.error('Download error:', error);
                showNotification('Error downloading QR code', 'error');
            }
        }

        // Helper function to escape product data for onclick
        function escapeProductData(product) {
            return JSON.stringify(product).replace(/"/g, '&quot;').replace(/'/g, "\\'");
        }

        function updateJSONOutput() {
            const jsonOutput = document.getElementById('jsonOutput');

            let productsToDisplay = PRODUCTS;

            // Apply current sorting to JSON output
            if (currentSortField !== 'none') {
                // Convert to array for sorting
                let productsArray = Object.entries(PRODUCTS);

                productsArray.sort((a, b) => {
                    const productA = a[1];
                    const productB = b[1];
                    let valueA, valueB;

                    switch (currentSortField) {
                        case 'name':
                            valueA = productA.itemName.toLowerCase();
                            valueB = productB.itemName.toLowerCase();
                            break;
                        case 'productCode':
                            valueA = productA.productCode.toLowerCase();
                            valueB = productB.productCode.toLowerCase();
                            break;
                        case 'itemName':
                            valueA = productA.itemName.toLowerCase();
                            valueB = productB.itemName.toLowerCase();
                            break;
                        case 'sectionCode':
                            valueA = (productA.sectionCode || '').toLowerCase();
                            valueB = (productB.sectionCode || '').toLowerCase();
                            break;
                        case 'sectionName':
                            valueA = (productA.sectionName || '').toLowerCase();
                            valueB = (productB.sectionName || '').toLowerCase();
                            break;
                        case 'cardType':
                            valueA = productA.hasVariants ? 'variant' : 'regular';
                            valueB = productB.hasVariants ? 'variant' : 'regular';
                            break;
                        default:
                            return 0;
                    }

                    // Handle empty values
                    if (!valueA) valueA = '';
                    if (!valueB) valueB = '';

                    let result = 0;
                    if (valueA < valueB) result = -1;
                    if (valueA > valueB) result = 1;

                    // Apply sort order
                    return currentSortOrder === 'asc' ? result : -result;
                });

                // Convert back to object while preserving order
                const sortedProducts = {};
                productsArray.forEach(([key, value]) => {
                    sortedProducts[key] = value;
                });

                productsToDisplay = sortedProducts;
            }

            const formattedJSON = JSON.stringify(productsToDisplay, null, 2)
                .replace(/\n/g, '<br>')
                .replace(/ /g, '&nbsp;');

            jsonOutput.innerHTML = formattedJSON;
        }

        // Navigation functions
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // Remove active class from all sidebar buttons
            document.querySelectorAll('.sidebar-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected section and activate button
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');

            // Close sidebar on mobile after selection
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }

            // Refresh data if needed
            if (sectionId === 'jsonData') {
                updateJSONOutput(); // This now includes sorting
            } else if (sectionId === 'addedItems') {
                displayProducts();
            } else if (sectionId === 'qrGridMaker') {
                updateQRGridPreview();
            }
        }

        // Utility functions
        function copyToClipboard() {
            const jsonText = JSON.stringify(PRODUCTS, null, 2);
            navigator.clipboard.writeText(jsonText).then(() => {
                showNotification('JSON copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showNotification('Failed to copy JSON', 'error');
            });
        }

        function refreshJSON() {
            updateJSONOutput();
            showNotification(`JSON data refreshed! ${currentSortField !== 'none' ? `(Sorted by: ${currentSortField}, Order: ${currentSortOrder})` : ''}`, 'success');
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const messageElement = document.getElementById('notificationMessage');

            messageElement.textContent = message;
            notification.className = `notification show ${type}`;

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.classList.add('hidden');
                }, 300);
            }, 3000);
        }

        // ===== STOCK MANAGEMENT SYSTEM =====

        // Stock Management Variables
        let stockHistory = JSON.parse(localStorage.getItem('stockHistory')) || [];
        let currentStockType = 'add';

        // Stock Manager Functions
        function openStockManager() {
            document.getElementById('stockModal').style.display = 'flex';
            showStockType('add');
        }

        function closeStockModal() {
            document.getElementById('stockModal').style.display = 'none';
        }

        function showStockType(type) {
            currentStockType = type;

            // Update buttons
            document.querySelectorAll('.stock-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Show/hide sections
            document.getElementById('addStockSection').style.display = type === 'add' ? 'block' : 'none';
            document.getElementById('reduceStockSection').style.display = type === 'reduce' ? 'block' : 'none';
        }

        function processStockOperation() {
            const inputField = document.getElementById(currentStockType + 'StockInput');
            const inputText = inputField.value.trim();

            if (!inputText) {
                showNotification('Please enter stock data', 'error');
                return;
            }

            try {
                // Parse the input array
                const data = parseStockInput(inputText);

                if (!data.products.length) {
                    showNotification('No valid products found in input', 'error');
                    return;
                }

                // Process stock operation
                const success = processStockData(data, currentStockType);

                if (success) {
                    // Save to history
                    saveToHistory(data, currentStockType);

                    // Close modal and show success
                    closeStockModal();
                    showNotification(`Stock ${currentStockType === 'add' ? 'added' : 'reduced'} successfully!`, 'success');

                    // Refresh products display
                    displayProducts();
                }

            } catch (error) {
                console.error('Stock operation error:', error);
                showNotification('Error processing stock data: ' + error.message, 'error');
            }
        }

        function parseStockInput(inputText) {
            // Remove brackets and split by commas
            const cleanText = inputText.replace(/[\[\]]/g, '');
            const items = cleanText.split(',').map(item => item.trim());

            const data = {
                products: [],
                customerNumber: '',
                customerName: ''
            };

            // Last two items are customer number and name
            if (items.length >= 2) {
                data.customerName = items.pop();
                data.customerNumber = items.pop();
            }

            // Process product codes and quantities
            items.forEach(item => {
                if (item.includes('@')) {
                    const [code, qty] = item.split('@');
                    if (code && qty && !isNaN(qty)) {
                        data.products.push({
                            code: code.trim(),
                            quantity: parseInt(qty.trim())
                        });
                    }
                }
            });

            return data;
        }

        function processStockData(data, operation) {
            let allProcessed = true;

            data.products.forEach(product => {
                const processed = updateProductStock(product.code, product.quantity, operation);
                if (!processed) {
                    allProcessed = false;
                    console.warn(`Failed to process product: ${product.code}`);
                }
            });

            return allProcessed;
        }

        function updateProductStock(productCode, quantity, operation) {
            // Search for product in main products
            for (let itemName in PRODUCTS) {
                const product = PRODUCTS[itemName];

                // Check main product
                if (product.productCode === productCode) {
                    const currentStock = parseInt(product.inStock) || 0;
                    product.inStock = operation === 'add' ? currentStock + quantity : Math.max(0, currentStock - quantity);
                    saveProduct(product); // Update in database
                    return true;
                }

                // Check variants if product has variants
                if (product.hasVariants && product.variants) {
                    for (let variantName in product.variants) {
                        const variant = product.variants[variantName];
                        if (variant.productCode === productCode) {
                            const currentStock = parseInt(variant.inStock) || 0;
                            variant.inStock = operation === 'add' ? currentStock + quantity : Math.max(0, currentStock - quantity);
                            saveProduct(product); // Update in database
                            return true;
                        }
                    }
                }
            }

            return false; // Product not found
        }

        // History Functions
        function openStockHistory() {
            document.getElementById('historyModal').style.display = 'flex';
            displayStockHistory();
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }

        function saveToHistory(data, type) {
            const historyEntry = {
                id: Date.now(),
                type: type,
                data: data,
                timestamp: new Date().toLocaleString()
            };

            stockHistory.unshift(historyEntry); // Add to beginning
            localStorage.setItem('stockHistory', JSON.stringify(stockHistory));
        }

        function displayStockHistory() {
            const tableBody = document.getElementById('historyTableBody');
            tableBody.innerHTML = '';

            if (stockHistory.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">No history available</td></tr>';
                return;
            }

            stockHistory.forEach((entry, index) => {
                const row = document.createElement('tr');

                // Format products array
                const productsText = entry.data.products.map(p => `${p.code}@${p.quantity}`).join(', ');
                const fullData = `[${productsText}, ${entry.data.customerNumber}, ${entry.data.customerName}]`;

                row.innerHTML = `
            <td>${index + 1}</td>
            <td style="font-family: monospace; font-size: 12px;">${fullData}</td>
            <td><span class="history-badge ${entry.type}">${entry.type.toUpperCase()}</span></td>
            <td>${entry.timestamp}</td>
        `;

                tableBody.appendChild(row);
            });
        }

        function printHistory() {
            const printWindow = window.open('', '_blank');
            const historyHTML = `
        <html>
            <head>
                <title>Stock History</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    table { width: 100%; border-collapse: collapse; }
                    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
                    th { background: #1a237e; color: white; }
                    .badge { padding: 4px 8px; border-radius: 4px; color: white; font-weight: bold; }
                    .add { background: #4caf50; }
                    .reduce { background: #f44336; }
                </style>
            </head>
            <body>
                <h2>Stock History</h2>
                ${document.getElementById('historyTableContainer').innerHTML}
            </body>
        </html>
    `;

            printWindow.document.write(historyHTML);
            printWindow.document.close();
            printWindow.print();
        }

        // Add CSS for history badges
        const style = document.createElement('style');
        style.textContent = `
    .history-badge {
        padding: 4px 8px;
        border-radius: 12px;
        color: white;
        font-size: 11px;
        font-weight: bold;
    }
    .history-badge.add { background: var(--secondary); }
    .history-badge.reduce { background: var(--danger); }
`;
        document.head.appendChild(style);


        // Sidebar functionality
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            const mainContainer = document.querySelector('.main-container');

            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
            document.body.classList.toggle('sidebar-open');
        }

        // Update showSection function to handle sidebar button states
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // Remove active class from all sidebar buttons
            document.querySelectorAll('.sidebar-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected section and activate button
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');

            // Close sidebar on mobile after selection
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }

            // Refresh data if needed
            if (sectionId === 'jsonData') {
                updateJSONOutput();
            } else if (sectionId === 'addedItems') {
                displayProducts();
            } else if (sectionId === 'qrGridMaker') {
                updateQRGridPreview();
            }
        }

        // Close sidebar when clicking on overlay
        document.addEventListener('DOMContentLoaded', function () {
            const overlay = document.querySelector('.sidebar-overlay');
            overlay.addEventListener('click', toggleSidebar);

            // Close sidebar when pressing Escape key
            document.addEventListener('keydown', function (event) {
                if (event.key === 'Escape') {
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar.classList.contains('open')) {
                        toggleSidebar();
                    }
                }
            });
        });
    </script>
</body>

</html>